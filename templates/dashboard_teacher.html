<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Teacher Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body {margin:0; font-family:Arial,sans-serif;}
.layout{display:flex; min-height:100vh;}
.sidebar{width:250px; background:#1e293b; color:#fff; padding:20px; transition:width .3s;}
.sidebar.collapsed{width:70px;}
.sidebar h2{margin-bottom:25px;}
.sidebar a{display:flex; align-items:center; gap:12px; color:#fff; text-decoration:none; padding:12px; border-radius:10px; margin-bottom:10px;}
.sidebar a:hover{background:#334155;}
.sidebar.collapsed a span{display:none;}
.main{flex:1;}
.teacher-bg{min-height:100vh; background:linear-gradient(rgba(255,255,255,0.45), rgba(255,248,248,0.45)), url("{{ url_for('static', filename='images/sg.jpeg') }}"); background-size:cover; background-position:center; background-attachment:fixed; padding:30px;}
.dashboard-container{max-width:1200px; margin:auto;}
.dashboard-header{display:flex;color:black; justify-content:space-between; align-items:center; background:#ffffffee; padding:15px 20px; border-radius:14px; margin-bottom:20px;}
.toggle-btn, .btn-logout{cursor:pointer; border:none; padding:8px 14px; border-radius:8px; font-weight:bold;}
.toggle-btn{background:#2563eb; color:#fff;}
.btn-logout{background:#dc2626; color:#fff;}
.card{background:#ffffffee; padding:20px; border-radius:16px; margin-bottom:20px;}
.form-row{display:flex; gap:15px; margin-bottom:15px; flex-wrap:wrap;}
.form-row input, .form-row select{flex:1; padding:10px; border-radius:8px; border:1px solid #a9b1f3ff;}
.btn-primary{background:#2563eb; color:#fff; border:none; padding:10px 16px; border-radius:8px; cursor:pointer; margin-right:8px;}
.btn-primary:hover{background:#1d4ed8;}
.student-table{width:100%; border-collapse:collapse;}
.student-table th, .student-table td{padding:10px; border-bottom:1px solid #c0b3deff; text-align:left;}
.student-table tr:hover{background:#f3f4f6;}
.status-safe{color:green;font-weight:bold;}
.status-warning{color:orange;font-weight:bold;}
.status-danger{color:red;font-weight:bold;}
.action-btn{padding:6px 10px; border:none; border-radius:6px; cursor:pointer; margin-right:5px; color:#fff;}
.edit-btn{background:#facc15;}
.edit-btn:hover{background:#eab308;}
.del-btn{background:#ef4444;}
.del-btn:hover{background:#dc2626;}
</style>
</head>
<body>

<div class="layout">

<!-- SIDEBAR -->
<div class="sidebar" id="sidebar">
  <h2><strong>EduTrack</strong></h2>
  <a href="{{ url_for('about') }}">About Us</a>
  <label>üåê Language</label>
  <select id="langSelect">
    <option value="">Select</option>
    <option value="en">English</option>
    <option value="hi">Hindi</option>
    <option value="mr">Marathi</option>
  </select>
</div>

<!-- MAIN -->
<div class="main">
<div class="teacher-bg" id="themeRoot">
<div class="dashboard-container">

<!-- HEADER -->
<div class="dashboard-header">
  <button class="toggle-btn" onclick="toggleSidebar()">‚ò∞</button>
  <h1>üë©‚Äçüè´ Teacher Dashboard</h1>
  <div>
    <button class="toggle-btn" onclick="toggleDark()">üåô Dark Mode</button>
    <a href="{{ url_for('logout') }}" class="btn-logout">Logout</a>
  </div>
</div>

<!-- ADD / EDIT STUDENT -->
<div class="card">
<h2>Add / Edit Student</h2>
<form method="POST" action="{{ url_for('add_student') }}" id="studentForm">
  <input type="hidden" name="student_id" id="student_id">
  
  <div class="form-row">
    <input type="text" name="name" id="name" placeholder="Student Name" required>
    <input type="number" name="roll" id="roll" placeholder="Roll No" required>
  </div>
  <div class="form-row">
    <input type="text" name="standard" id="standard" placeholder="Standard" required>
    <select name="division" id="division" required>
      <option value="">Division</option>
      <option>A</option><option>B</option><option>C</option><option>D</option><option>E</option>
    </select>
  </div>
  <div class="form-row">
    <select name="month" id="month" required>
      <option value="">Select Month</option>
      <option>January</option><option>February</option><option>March</option>
      <option>April</option><option>May</option><option>June</option>
      <option>July</option><option>August</option><option>September</option>
      <option>October</option><option>November</option>
    </select>
  </div>

  <h3>Subjects & Attendance</h3>
  <div id="subjects-container">
    <div class="form-row">
      <input type="text" name="subjects[]" placeholder="Subject" required>
      <input type="number" name="attendance[]" min="0" max="100" placeholder="Attendance %" required>
    </div>
  </div>
  <button type="button" class="btn-primary" onclick="addSubject()">+ Add Subject</button>

  <div class="form-row" style="margin-top:10px;">
    <select name="assignment" id="assignment" required>
      <option value="">Assignment Status</option>
      <option>Completed</option>
      <option>Pending</option>
    </select>
    <select name="quiz" id="quiz" required>
      <option value="">Quiz Performance</option>
      <option>Excellent</option>
      <option>Good</option>
      <option>Average</option>
      <option>Poor</option>
    </select>
  </div>

  <div style="margin-top:10px;">
    <button type="submit" class="btn-primary" id="submitBtn">Add Student</button>
    <button type="button" class="btn-primary" onclick="resetForm()" style="background:#6b7280;">Reset</button>
  </div>
</form>
</div>

<!-- STUDENT RECORDS -->
<div class="card">
<h2>Student Records</h2>
<input type="text" id="searchInput" placeholder="Search by name/roll" style="margin-bottom:10px; padding:6px; width:100%;">
<div class="table-wrapper">
<table class="student-table" id="studentTable">
<thead>
<tr>
  <th>Name</th><th>Roll</th><th>Std</th><th>Div</th>
  <th>Month</th><th>Attendance</th><th>Assignment</th><th>Quiz</th><th>Risk</th><th>Actions</th>
</tr>
</thead>
<tbody>
{% for s in students %}
<tr data-id="{{ s.id }}">
  <td>{{ s.name }}</td>
  <td>{{ s.roll }}</td>
  <td>{{ s.standard }}</td>
  <td>{{ s.division }}</td>
  <td>{{ s.month }}</td>
  <td>
    {% for sub in s.subjects %}{{ sub.name }}: {{ sub.attendance }}%<br>{% endfor %}
    <strong>Avg: {{ s.avg }}%</strong>
  </td>
  <td>{{ s.assignment }}</td>
  <td>{{ s.quiz }}</td>
  <td>
    {% if s.avg < 75 %}
      {% if s.get('parent_calls',0) < 2 %}
        <span class="status-warning">Parent Called ({{ s.get('parent_calls',0) }})</span>
      {% else %}
        <span class="status-danger">Escalated to Principal</span>
      {% endif %}
    {% else %}
      <span class="status-safe">Safe</span>
    {% endif %}
  </td>
  <td>
    <button class="action-btn edit-btn" onclick='editStudent({{ s|tojson }})'>Edit</button>
    <button class="action-btn del-btn" onclick='deleteStudent({{ s.id }})'>Delete</button>
  </td>
</tr>
{% endfor %}
</tbody>
</table>
</div>
</div>

<!-- ATTENDANCE CHART -->
<div class="card">
<h2>Attendance Analysis</h2>
<canvas id="attendanceChart" height="100"></canvas>
</div>

</div>
</div>
</div>
</div>

<script>
// SIDEBAR & DARK MODE
function toggleSidebar(){ document.getElementById("sidebar").classList.toggle("collapsed"); }
function toggleDark(){ document.getElementById("themeRoot").classList.toggle("dark-mode"); }

// SUBJECTS
function addSubject(){
  const c = document.getElementById("subjects-container");
  const r = document.createElement("div");
  r.className="form-row";
  r.innerHTML=`<input type="text" name="subjects[]" placeholder="Subject" required>
               <input type="number" name="attendance[]" min="0" max="100" placeholder="Attendance %" required>`;
  c.appendChild(r);
}

// EDIT STUDENT
function editStudent(s){
  document.getElementById("student_id").value=s.id;
  document.getElementById("name").value=s.name;
  document.getElementById("roll").value=s.roll;
  document.getElementById("standard").value=s.standard;
  document.getElementById("division").value=s.division;
  document.getElementById("month").value=s.month;
  document.getElementById("assignment").value=s.assignment;
  document.getElementById("quiz").value=s.quiz;

  // clear old subjects
  const container=document.getElementById("subjects-container");
  container.innerHTML="";
  s.subjects.forEach(sub=>{
    const r=document.createElement("div");
    r.className="form-row";
    r.innerHTML=`<input type="text" name="subjects[]" value="${sub.name}" required>
                 <input type="number" name="attendance[]" value="${sub.attendance}" min="0" max="100" required>`;
    container.appendChild(r);
  });
  document.getElementById("submitBtn").innerText="Update Student";
}

// RESET FORM
function resetForm(){
  document.getElementById("studentForm").reset();
  document.getElementById("student_id").value="";
  document.getElementById("submitBtn").innerText="Add Student";
}

// DELETE
function deleteStudent(id){
  if(confirm("Are you sure you want to delete this student?")){
    fetch(`/teacher/delete-student/${id}`,{method:'POST'}).then(()=>location.reload());
  }
}

// SEARCH
document.getElementById("searchInput").addEventListener("keyup",function(){
  const filter=this.value.toLowerCase();
  document.querySelectorAll("#studentTable tbody tr").forEach(tr=>{
    tr.style.display=Array.from(tr.children).some(td=>td.textContent.toLowerCase().includes(filter))?"":"none";
  });
});

// CHART
const ctx=document.getElementById('attendanceChart').getContext('2d');
const studentNames=[{% for s in students %}"{{ s.name }}",{% endfor %}];
const studentAvgAttendance=[{% for s in students %}{{ s.avg }},{% endfor %}];
new Chart(ctx,{
  type:'bar',
  data:{labels:studentNames,datasets:[{label:'Average Attendance (%)',data:studentAvgAttendance,backgroundColor:'rgba(37,99,235,0.7)',borderColor:'rgba(37,99,235,1)',borderWidth:1,borderRadius:6}]},
  options:{responsive:true,plugins:{legend:{display:false},tooltip:{callbacks:{label:ctx=>ctx.parsed.y+'%'}}},scales:{y:{beginAtZero:true,max:100,title:{display:true,text:'Attendance (%)'}},x:{title:{display:true,text:'Students'}}}}
});
</script>
</body>
</html>
