{% extends "base.html" %}
{% block title %}NGO Admin Dashboard - EduDrop{% endblock %}

{% block page_title %}Admin Dashboard{% endblock %}

{% block sidebar %}
<a href="#" class="active"><i class="bi bi-speedometer2"></i><span>Dashboard</span></a>
<a href="/admin/add-volunteer"><i class="bi bi-people"></i><span>Add Volunteer</span></a>
{% endblock %}

{% block content %}

<!-- Welcome Card -->
<div class="card mb-4">
  <div class="d-flex justify-content-between align-items-center">
    <div>
      <h4 style="font-weight:600;margin-bottom:8px;">Welcome, {{ admin.name }}</h4>
      <p style="color:var(--muted);margin:0;">{{ admin.ngo_name }}</p>
    </div>
    <div style="font-size:3rem;color:var(--primary);">
      <i class="bi bi-shield-check"></i>
    </div>
  </div>
</div>

<!-- Stats -->
<div class="row g-4 mb-4">
  <div class="col-sm-6 col-lg-4">
    <div class="stat-card" style="border-left-color:var(--warning);">
      <div class="stat-label" style="color:var(--warning);">Pending Approvals</div>
      <div class="stat-value" style="color:var(--warning);">{{ pending_cases|length }}</div>
    </div>
  </div>
  <div class="col-sm-6 col-lg-4">
    <div class="stat-card">
      <div class="stat-label">Quick Actions</div>
      <a href="/admin/add-volunteer" class="btn btn-primary" style="margin-top:8px;font-size:0.85rem;"><i class="bi bi-person-plus"></i> Add Volunteer</a>
    </div>
  </div>
</div>

<!-- Pending Intervention Approvals -->
<div class="card mb-4">
  <h6 style="font-weight:600;margin-bottom:16px;color:var(--warning);">
    <i class="bi bi-clock-history"></i> Pending Intervention Approvals
  </h6>
  {% if pending_cases %}
  <div class="table-responsive">
    <table class="table-clean">
      <thead>
        <tr><th>Student</th><th>Roll</th><th>Type</th><th>Status</th><th>Notes</th><th>By</th><th>Proof</th><th>Action</th></tr>
      </thead>
      <tbody>
        {% for c in pending_cases %}
        <tr>
          <td>{{ c.student_performance.name if c.student_performance else 'N/A' }}</td>
          <td>{{ c.student_performance.roll if c.student_performance else '-' }}</td>
          <td>
            {{ c.type or '-' }}
            {% if c.type == 'Financial Aid' %}
            <br><small style="color:var(--danger);font-weight:600;">Requires Approval</small>
            {% endif %}
          </td>
          <td>
            {% if c.status == 'Awaiting Approval' %}
              <span class="badge-danger">Awaiting Approval</span>
            {% else %}
              <span class="badge-warning">{{ c.status }}</span>
            {% endif %}
          </td>
          <td>{{ c.notes or '-' }}</td>
          <td>{{ c.by or '-' }}</td>
          <td>
            {% if c.proof_image %}
            <a href="{{ c.proof_image }}" target="_blank" style="display:inline-block;">
              <img src="{{ c.proof_image }}" alt="Proof" style="width:80px;height:60px;object-fit:cover;border-radius:6px;border:1px solid var(--border);">
            </a>
            {% else %}
            <span style="color:var(--muted);font-size:0.85rem;">No proof</span>
            {% endif %}
          </td>
<td>
  <div class="d-flex gap-2 align-items-start">
    <!-- Approve form (unchanged) -->
    <form method="POST" action="/approve-intervention/{{ c.id }}" style="margin:0;">
      <button type="submit" class="btn btn-primary" style="font-size:0.8rem;padding:4px 12px;"
              onclick="return confirm('Approve this intervention?')">
        <i class="bi bi-check-lg"></i> Approve
      </button>
    </form>

    <!-- Reject toggle + inline form -->
    <div style="position:relative;">
      <button type="button" class="btn btn-danger" style="font-size:0.8rem;padding:4px 12px;"
              onclick="toggleRejectForm('{{ c.id }}')">
        <i class="bi bi-x-lg"></i> Reject
      </button>

      <form id="reject-form-{{ c.id }}" method="POST" action="/reject-intervention/{{ c.id }}"
            style="display:none; margin-top:8px; background:var(--bg); padding:8px; border-radius:6px; box-shadow:var(--shadow);">
        <textarea name="approval_notes" placeholder="Reason for rejection (optional)" rows="3"
                  style="width:260px; resize:vertical; font-size:0.85rem; padding:6px; border-radius:6px;"></textarea>
        <div class="d-flex gap-2" style="margin-top:6px;">
          <button type="submit" class="btn btn-danger" style="font-size:0.8rem;padding:4px 10px;"
                  onclick="return confirm('Reject and save note?')">Submit Reject</button>
          <button type="button" class="btn btn-outline" onclick="toggleRejectForm('{{ c.id }}')">Cancel</button>
        </div>
      </form>
    </div>
  </div>
</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  {% else %}
  <p style="color:var(--muted);">No pending interventions to review.</p>
  {% endif %}
</div>

<script>
function toggleRejectForm(id) {
  const form = document.getElementById(`reject-form-${id}`);
  if (!form) return;
  form.style.display = form.style.display === 'none' || form.style.display === '' ? 'block' : 'none';
}
</script>

{% set chatbot_greeting = "Hi! I'm EduBot, your NGO admin assistant. Ask me about managing volunteers, reviewing interventions, or student welfare strategies!" %}
{% set chatbot_subtitle = "NGO Admin Assistant" %}
{% set chatbot_role = "ngo_admin" %}
{% include 'partials/chatbot.html' %}

{% endblock %}
