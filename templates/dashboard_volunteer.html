{% extends "base.html" %}
{% block title %}Volunteer Dashboard - EduDrop{% endblock %}

{% block page_title %}NGO Volunteer Dashboard{% endblock %}

{% block sidebar %}
<a href="#" class="active"><i class="bi bi-speedometer2"></i><span>Dashboard</span></a>
<a href="/about"><i class="bi bi-info-circle"></i><span>About Us</span></a>
{% endblock %}

{% block content %}

<!-- Metrics -->
<div class="row g-4 mb-4">
  <div class="col-sm-6 col-lg-4">
    <div class="stat-card">
      <div class="stat-label">At-Risk Students</div>
      <div class="stat-value">{{ students | length }}</div>
    </div>
  </div>
  <div class="col-sm-6 col-lg-4">
    <div class="stat-card" style="border-left-color:var(--accent);">
      <div class="stat-label">Students Helped</div>
      <div class="stat-value">{{ interventions | length }}</div>
    </div>
  </div>
  <div class="col-sm-6 col-lg-4">
    <div class="stat-card" style="border-left-color:var(--warning);">
      <div class="stat-label">Active Interventions</div>
      <div class="stat-value">{{ active_interventions }}</div>
    </div>
  </div>
</div>

<!-- Risk Filter -->
<div class="mb-4">
  <select class="form-control" style="max-width:200px;" onchange="filterRisk(this.value)">
    <option value="all">All Risk Levels</option>
    <option value="At Risk">At Risk</option>
    <option value="Medium">Medium</option>
  </select>
</div>

<!-- At-Risk Students -->
<div class="card mb-4">
  <h6 style="font-weight:600;margin-bottom:16px;color:var(--danger);">At-Risk Students</h6>
  <div class="table-responsive">
    <table class="table-clean" id="riskTable">
      <thead>
        <tr>
<th>Name</th>
<th>Roll</th>
<th>Division</th>
<th>Parent Phone</th>
<th>Parent Address</th>
<th>Risk</th>
<th>Insight</th>
<th>Intervention</th>
<th>Status</th>
<th>Notes</th>
<th>Action</th>
        </tr>
      </thead>
      <tbody>
        {% for s in students %}
        <tr data-risk="{{ s.risk }}">
<td>{{ s.name }}</td>
<td>{{ s.roll }}</td>
<td>{{ s.division }}</td>
<td>{{ s.parent_phone or '-' }}</td>
<td style="max-width:150px;word-break:break-word;">
    {{ s.parent_address or '-' }}
</td><td>
            {% if s.risk in ['High Risk', 'Medium Risk'] %}
              <span class="badge-danger">URGENT</span>
            {% else %}
              <span class="badge-warning">ATTENTION</span>
            {% endif %}
          </td>
          <td>
            <button class="btn btn-outline" style="font-size:0.8rem;padding:4px 10px;" onclick="toggleReason(this)">View</button>
            <div class="reason-box" style="display:none;margin-top:8px;padding:10px;background:var(--bg);border-radius:8px;font-size:0.85rem;">
              <strong>Reason:</strong><br>{{ s.ai_reason }}<br>
              <small style="color:var(--muted);">Confidence: {{ s.ai_confidence }}</small>
            </div>
          </td>
          <td>{{ s.current_intervention }}</td>
          <td>
            {% if s.current_status == "Ongoing" %}<span class="badge-danger">Ongoing</span>
            {% elif s.current_status == "Planned" %}<span class="badge-warning">Planned</span>
            {% else %}{{ s.current_status }}{% endif %}
          </td>
          <td>{{ s.current_notes }}</td>
          <td>
            <form method="POST" enctype="multipart/form-data" style="min-width:200px;">
              <input type="hidden" name="student_id" value="{{ s.id }}">
              <select name="intervention_type" class="form-control mb-2" style="font-size:0.85rem;">
                <option value="">Intervention</option>
                <option>Counselling</option>
                <option>Parent Meeting</option>
                <option>Financial Aid</option>
                <option>Mentorship</option>
              </select>
              <select name="status" class="form-control mb-2" style="font-size:0.85rem;" required onchange="toggleUpload(this)">
                <option value="">Status</option>
                <option>Planned</option>
                <option>Ongoing</option>
                <option>Completed</option>
              </select>
              <div class="proof-upload" style="display:none;margin-bottom:8px;">
                <label class="form-label" style="font-size:0.8rem;">Proof Photo:</label>
                <input type="file" name="proof_image" class="form-control" style="font-size:0.8rem;">
              </div>
              <textarea name="notes" class="form-control mb-2" style="font-size:0.85rem;" rows="2" required placeholder="Notes..."></textarea>
              <button class="btn btn-primary" style="font-size:0.8rem;padding:4px 12px;">Save</button>
            </form>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<!-- Intervention History -->
<div class="card">
  <h6 style="font-weight:600;margin-bottom:16px;">Intervention History</h6>
  {% if interventions %}
  <div class="table-responsive">
    <table class="table-clean">
      <thead>
        <tr><th>Student</th><th>Roll</th><th>Type</th><th>Status</th><th>Notes</th><th>By</th></tr>
      </thead>
      <tbody>
        {% for a in interventions %}
        <tr>
          <td>{{ a.student_performance.name }}</td>
          <td>{{ a.student_performance.roll }}</td>
          <td>{{ a.type }}</td>
          <td>
            {% if a.status == "Completed" %}<span class="badge-success">Completed</span>
            {% elif a.status == "Ongoing" %}<span class="badge-danger">Ongoing</span>
            {% else %}<span class="badge-warning">Planned</span>{% endif %}
          </td>
          <td>{{ a.notes }}</td>
          <td>{{ a.by }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  {% else %}
  <p style="color:var(--muted);">No interventions recorded yet.</p>
  {% endif %}
</div>

<script>
function toggleUpload(select) {
  const box = select.closest("form").querySelector(".proof-upload");
  box.style.display = select.value === "Completed" ? "block" : "none";
}

function filterRisk(val) {
  document.querySelectorAll("#riskTable tbody tr").forEach(r => {
    r.style.display = (val === "all" || (r.dataset.risk || '').trim() === val) ? "" : "none";
  });
}

function toggleReason(btn) {
  const box = btn.nextElementSibling;
  if (box.style.display === "none") { box.style.display = "block"; btn.textContent = "Hide"; }
  else { box.style.display = "none"; btn.textContent = "View"; }
}
</script>

{% endblock %}