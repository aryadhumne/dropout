{% extends "base.html" %}
{% block title %}Volunteer Dashboard - EduDrop{% endblock %}

{% block page_title %}NGO Volunteer Dashboard{% endblock %}

{% block sidebar %}
<a href="#" class="active"><i class="bi bi-speedometer2"></i><span>Dashboard</span></a>
{% endblock %}

{% block content %}

<!-- Metrics -->
<div class="row g-4 mb-4">
  <div class="col-sm-6 col-lg-4">
    <div class="stat-card">
      <div class="stat-label">At-Risk Students</div>
      <div class="stat-value">{{ students | length }}</div>
    </div>
  </div>
  <div class="col-sm-6 col-lg-4">
    <div class="stat-card" style="border-left-color:var(--accent);">
      <div class="stat-label">Students Helped</div>
      <div class="stat-value">{{ interventions | length }}</div>
    </div>
  </div>
  <div class="col-sm-6 col-lg-4">
    <div class="stat-card" style="border-left-color:var(--warning);">
      <div class="stat-label">Active Interventions</div>
      <div class="stat-value">{{ active_interventions }}</div>
    </div>
  </div>
</div>

<!-- Tabs -->
<div style="display:flex;gap:0;margin-bottom:0;border-bottom:2px solid var(--border);">
  <button class="vol-tab active" onclick="switchTab('students')" id="tab-students" style="padding:10px 24px;font-weight:600;font-size:0.9rem;border:none;background:none;color:var(--muted);cursor:pointer;border-bottom:2px solid transparent;margin-bottom:-2px;">
    <i class="bi bi-people-fill"></i> At-Risk Students
  </button>
  <button class="vol-tab" onclick="switchTab('history')" id="tab-history" style="padding:10px 24px;font-weight:600;font-size:0.9rem;border:none;background:none;color:var(--muted);cursor:pointer;border-bottom:2px solid transparent;margin-bottom:-2px;">
    <i class="bi bi-clock-history"></i> Intervention History
  </button>
</div>

<!-- ============ TAB 1: At-Risk Students ============ -->
<div id="panel-students" style="margin-top:20px;">

  <!-- Risk Filter -->
  <div class="mb-4">
    <select class="form-control" style="max-width:200px;" onchange="filterRisk(this.value)">
      <option value="all">All Risk Levels</option>
      <option value="At Risk">At Risk</option>
      <option value="Medium">Medium</option>
    </select>
  </div>

  {% if students %}
  <div class="row g-3" id="studentCards">
    {% for s in students %}
    <div class="col-12" data-risk="{{ s.risk }}">
      <div class="card" style="padding:0;overflow:hidden;">

        <!-- Card Header -->
        <div style="display:flex;justify-content:space-between;align-items:center;padding:14px 20px;border-bottom:1px solid var(--border);flex-wrap:wrap;gap:8px;">
          <div style="display:flex;align-items:center;gap:12px;">
            <div style="width:38px;height:38px;border-radius:50%;background:var(--primary-light);display:flex;align-items:center;justify-content:center;font-weight:700;color:var(--primary);font-size:0.9rem;flex-shrink:0;">
              {{ s.name[0] if s.name else '?' }}
            </div>
            <div>
              <div style="font-weight:600;font-size:0.95rem;">{{ s.name }}</div>
              <div style="font-size:0.78rem;color:var(--muted);">Roll: {{ s.roll }} &middot; Div: {{ s.division }}</div>
            </div>
          </div>
          <div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap;">
            {% if s.risk in ['High Risk', 'Medium Risk'] %}
              <span class="badge-danger">URGENT</span>
            {% else %}
              <span class="badge-warning">ATTENTION</span>
            {% endif %}
            {% if s.current_status == "Ongoing" %}<span class="badge-danger">Ongoing</span>
            {% elif s.current_status == "Planned" %}<span class="badge-warning">Planned</span>
            {% elif s.current_status == "Rejected" %}<span class="badge-danger">Rejected</span>
            {% elif s.current_status != "-" %}<span class="badge-success">{{ s.current_status }}</span>
            {% endif %}
          </div>
        </div>

        <!-- Card Body: 3 equal columns -->
        <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:0;min-height:0;" class="vol-card-body">

          <!-- Col 1: Student Details -->
          <div style="padding:16px 20px;border-right:1px solid var(--border);">
            <div style="font-weight:600;font-size:0.8rem;color:var(--primary);margin-bottom:10px;text-transform:uppercase;letter-spacing:0.5px;">
              <i class="bi bi-person-lines-fill"></i> Student Info
            </div>
            <div style="display:flex;flex-direction:column;gap:10px;font-size:0.84rem;">
              <div>
                <span style="color:var(--muted);font-size:0.78rem;">Parent Phone</span>
                <div style="font-weight:500;">{{ s.parent_phone or '-' }}</div>
              </div>
              <div>
                <span style="color:var(--muted);font-size:0.78rem;">Parent Address</span>
                <div style="font-weight:500;word-break:break-word;">{{ s.parent_address or '-' }}</div>
              </div>
              <div>
                <span style="color:var(--muted);font-size:0.78rem;">Current Intervention</span>
                <div style="font-weight:500;">{{ s.current_intervention }}</div>
              </div>
              <div>
                <span style="color:var(--muted);font-size:0.78rem;">Notes</span>
                <div style="font-weight:500;display:flex;align-items:flex-start;gap:6px;">
                  <span class="tts-text">{{ s.current_notes }}</span>
                  {% if s.current_notes and s.current_notes != '-' %}
                  <button type="button" class="vol-tts-btn" onclick="volSpeak(this)" title="Listen"><i class="bi bi-volume-up-fill"></i></button>
                  {% endif %}
                </div>
              </div>
            </div>
          </div>

          <!-- Col 2: AI Insight -->
          <div style="padding:16px 20px;border-right:1px solid var(--border);">
            <div style="font-weight:600;font-size:0.8rem;color:var(--accent);margin-bottom:10px;text-transform:uppercase;letter-spacing:0.5px;">
              <i class="bi bi-cpu"></i> AI Insight
            </div>
            <div style="font-size:0.84rem;line-height:1.6;">
              <div style="margin-bottom:8px;">{{ s.ai_reason }}</div>
              <div style="font-size:0.78rem;color:var(--muted);margin-bottom:10px;">Confidence: {{ s.ai_confidence }}</div>
              {% if s.ai_suggestions %}
              <div style="padding:10px;background:rgba(231,33,145,0.05);border-radius:8px;border-left:3px solid var(--accent);display:flex;align-items:flex-start;gap:6px;">
                <div style="font-size:0.82rem;line-height:1.5;flex:1;"><i class="bi bi-lightbulb" style="color:var(--accent);"></i> <span class="tts-text">{{ s.ai_suggestions }}</span></div>
                <button type="button" class="vol-tts-btn" onclick="volSpeak(this)" title="Listen"><i class="bi bi-volume-up-fill"></i></button>
              </div>
              {% endif %}
            </div>
          </div>

          <!-- Col 3: Add Intervention -->
          <div style="padding:16px 20px;">
            <div style="font-weight:600;font-size:0.8rem;color:var(--primary);margin-bottom:10px;text-transform:uppercase;letter-spacing:0.5px;">
              <i class="bi bi-plus-circle"></i> Add Intervention
            </div>
            <form method="POST" enctype="multipart/form-data">
              <input type="hidden" name="student_id" value="{{ s.id }}">
              <div style="display:flex;flex-direction:column;gap:8px;">
                <select name="intervention_type" class="form-control" style="font-size:0.84rem;">
                  <option value="">Select Type</option>
                  <option>Counselling</option>
                  <option>Parent Meeting</option>
                  <option>Financial Aid</option>
                  <option>Mentorship</option>
                </select>
                <select name="status" class="form-control" style="font-size:0.84rem;" required onchange="toggleUpload(this)">
                  <option value="">Select Status</option>
                  <option>Planned</option>
                  <option>Ongoing</option>
                  <option>Completed</option>
                </select>
                <div class="proof-upload" style="display:none;">
                  <label class="form-label" style="font-size:0.78rem;margin-bottom:2px;">Proof Photo:</label>
                  <input type="file" name="proof_image" class="form-control" style="font-size:0.8rem;">
                </div>
                <div style="position:relative;">
                  <textarea name="notes" class="form-control vol-notes-area" style="font-size:0.84rem;padding-right:36px;" rows="2" required placeholder="Add notes..."></textarea>
                  <button type="button" class="vol-mic-btn" onclick="volSTT(this)" title="Voice input"><i class="bi bi-mic-fill"></i></button>
                </div>
                <button class="btn btn-primary" style="font-size:0.84rem;padding:6px 16px;align-self:flex-start;"><i class="bi bi-check-lg"></i> Save</button>
              </div>
            </form>
          </div>

        </div>
      </div>
    </div>
    {% endfor %}
  </div>
  {% else %}
  <div class="card">
    <p style="color:var(--muted);margin:0;">No at-risk students found.</p>
  </div>
  {% endif %}
</div>

<!-- ============ TAB 2: Intervention History ============ -->
<div id="panel-history" style="display:none;margin-top:20px;">
  <div class="card">
    <h6 style="font-weight:600;margin-bottom:16px;"><i class="bi bi-clock-history"></i> All Interventions</h6>
    <p style="font-size:0.8rem;color:var(--muted);margin-bottom:12px;">Click on a student to view full details</p>
    {% if interventions %}
    <div class="table-responsive">
      <table class="table-clean">
        <thead>
          <tr><th>Student</th><th>Roll</th><th>Type</th><th>Status</th><th>Notes</th><th>By</th></tr>
        </thead>
        <tbody>
          {% for a in interventions %}
          {% set sp = a.student_performance %}
          <tr style="cursor:pointer;" onclick="showStudentDetail({{ loop.index0 }})">
            <td style="color:var(--accent);font-weight:600;">{{ sp.name if sp else 'N/A' }}</td>
            <td>{{ sp.roll if sp else '-' }}</td>
            <td>{{ a.type }}</td>
            <td>
              {% if a.status == "Completed" %}<span class="badge-success">Completed</span>
              {% elif a.status == "Ongoing" %}<span class="badge-danger">Ongoing</span>
              {% else %}<span class="badge-warning">Planned</span>{% endif %}
            </td>
            <td>{{ a.notes }}</td>
            <td>{{ a.by }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    {% else %}
    <p style="color:var(--muted);">No interventions recorded yet.</p>
    {% endif %}
  </div>
</div>

<script>
var _interventionData = {{ interventions|tojson }};

function showStudentDetail(idx) {
  var item = _interventionData[idx];
  if (!item) return;
  var sp = item.student_performance || {};

  var riskBadge = '';
  var risk = sp.risk || 'N/A';
  if (risk === 'High Risk') riskBadge = '<span style="background:#fef2f2;color:#dc2626;padding:3px 10px;border-radius:12px;font-size:0.78rem;font-weight:700;">High Risk</span>';
  else if (risk === 'Medium Risk') riskBadge = '<span style="background:#fffbeb;color:#b45309;padding:3px 10px;border-radius:12px;font-size:0.78rem;font-weight:700;">Medium Risk</span>';
  else riskBadge = '<span style="background:#f0fdf4;color:#16a34a;padding:3px 10px;border-radius:12px;font-size:0.78rem;font-weight:700;">Low Risk</span>';

  var html = '<div style="text-align:left;font-size:0.9rem;line-height:1.8;">';

  // Student Info Section
  html += '<div style="display:flex;align-items:center;gap:12px;margin-bottom:16px;padding-bottom:12px;border-bottom:1px solid #e5e7eb;">';
  html += '<div style="width:48px;height:48px;border-radius:50%;background:#eef2ff;display:flex;align-items:center;justify-content:center;font-weight:700;color:#1e1b4b;font-size:1.1rem;flex-shrink:0;">' + ((sp.name || '?')[0]) + '</div>';
  html += '<div><div style="font-weight:700;font-size:1.05rem;">' + (sp.name || 'N/A') + '</div>';
  html += '<div style="color:#6b7280;font-size:0.82rem;">Roll: ' + (sp.roll || '-') + ' &middot; Class ' + (sp.standard || '-') + '-' + (sp.division || '-') + '</div></div>';
  html += '<div style="margin-left:auto;">' + riskBadge + '</div>';
  html += '</div>';

  // Details Grid
  html += '<div style="display:grid;grid-template-columns:1fr 1fr;gap:8px 24px;">';
  html += '<div><span style="color:#6b7280;font-size:0.78rem;">Gender</span><br><strong>' + (sp.gender || '-') + '</strong></div>';
  html += '<div><span style="color:#6b7280;font-size:0.78rem;">Email</span><br><strong>' + (sp.email || '-') + '</strong></div>';
  html += '<div><span style="color:#6b7280;font-size:0.78rem;">Attendance</span><br><strong>' + (sp.attendance != null ? sp.attendance + '%' : '-') + '</strong></div>';
  html += '<div><span style="color:#6b7280;font-size:0.78rem;">Monthly Test</span><br><strong>' + (sp.monthly_test_score != null ? sp.monthly_test_score : '-') + '</strong></div>';
  html += '<div><span style="color:#6b7280;font-size:0.78rem;">Assignment</span><br><strong>' + (sp.assignment || '-') + '</strong></div>';
  html += '<div><span style="color:#6b7280;font-size:0.78rem;">Quiz</span><br><strong>' + (sp.quiz || '-') + '</strong></div>';
  html += '<div><span style="color:#6b7280;font-size:0.78rem;">Behaviour</span><br><strong>' + (sp.behaviour || '-') + '</strong></div>';
  html += '<div><span style="color:#6b7280;font-size:0.78rem;">Risk Status</span><br><strong>' + (sp.risk_status || '-') + '</strong></div>';
  html += '</div>';

  // Risk Reason
  if (sp.risk_reason) {
    html += '<div style="margin-top:12px;padding:10px;background:#fef2f2;border-radius:8px;border-left:3px solid #dc2626;font-size:0.84rem;">';
    html += '<strong style="color:#dc2626;">Risk Reason:</strong> ' + sp.risk_reason;
    html += '</div>';
  }

  // Parent Info
  html += '<div style="margin-top:14px;padding-top:12px;border-top:1px solid #e5e7eb;">';
  html += '<div style="font-weight:600;font-size:0.8rem;color:#1e1b4b;text-transform:uppercase;letter-spacing:0.5px;margin-bottom:8px;"><i class="bi bi-people-fill"></i> Parent Details</div>';
  html += '<div style="display:grid;grid-template-columns:1fr 1fr;gap:8px 24px;">';
  html += '<div><span style="color:#6b7280;font-size:0.78rem;">Parent Name</span><br><strong>' + (sp.parent_name || '-') + '</strong></div>';
  html += '<div><span style="color:#6b7280;font-size:0.78rem;">Phone</span><br><strong>' + (sp.parent_phone || '-') + '</strong></div>';
  html += '<div style="grid-column:span 2;"><span style="color:#6b7280;font-size:0.78rem;">Address</span><br><strong>' + (sp.parent_address || '-') + '</strong></div>';
  html += '</div></div>';

  // Intervention Info
  html += '<div style="margin-top:14px;padding-top:12px;border-top:1px solid #e5e7eb;">';
  html += '<div style="font-weight:600;font-size:0.8rem;color:var(--accent);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:8px;"><i class="bi bi-clipboard-check"></i> Intervention</div>';
  html += '<div style="display:grid;grid-template-columns:1fr 1fr;gap:8px 24px;">';
  html += '<div><span style="color:#6b7280;font-size:0.78rem;">Type</span><br><strong>' + (item.type || '-') + '</strong></div>';
  html += '<div><span style="color:#6b7280;font-size:0.78rem;">Status</span><br><strong>' + (item.status || '-') + '</strong></div>';
  html += '<div><span style="color:#6b7280;font-size:0.78rem;">By</span><br><strong>' + (item.by || '-') + '</strong></div>';
  html += '<div><span style="color:#6b7280;font-size:0.78rem;">Date</span><br><strong>' + (item.created_at ? new Date(item.created_at).toLocaleDateString('en-IN') : '-') + '</strong></div>';
  html += '</div>';
  if (item.notes) {
    html += '<div style="margin-top:8px;"><span style="color:#6b7280;font-size:0.78rem;">Notes</span><br><strong>' + item.notes + '</strong></div>';
  }
  html += '</div>';

  html += '</div>';

  Swal.fire({
    title: '',
    html: html,
    width: 560,
    showCloseButton: true,
    showConfirmButton: false,
    customClass: { popup: 'student-detail-popup' }
  });
}
</script>

{% set chatbot_greeting = "Hi! I'm EduBot, your volunteer assistant. Ask me about intervention strategies, how to approach at-risk students, or tips for effective mentoring!" %}
{% set chatbot_subtitle = "Volunteer Assistant" %}
{% set chatbot_role = "volunteer" %}
{% include 'partials/chatbot.html' %}

<style>
.vol-tts-btn {
  background: none;
  border: none;
  color: var(--accent);
  cursor: pointer;
  padding: 2px 4px;
  font-size: 0.85rem;
  flex-shrink: 0;
  border-radius: 4px;
  transition: background 0.2s;
}
.vol-tts-btn:hover {
  background: rgba(231,33,145,0.1);
}
.vol-mic-btn {
  position: absolute;
  right: 6px;
  top: 6px;
  background: none;
  border: none;
  color: var(--accent);
  cursor: pointer;
  font-size: 0.95rem;
  padding: 2px 5px;
  border-radius: 4px;
  transition: background 0.2s;
}
.vol-mic-btn:hover {
  background: rgba(231,33,145,0.1);
}
.vol-mic-btn.listening {
  color: #ef4444;
  animation: pulse 1.2s infinite;
}
@keyframes pulse {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.4; }
}
/* Responsive: stack columns on smaller screens */
@media (max-width: 992px) {
  .vol-card-body {
    grid-template-columns: 1fr !important;
  }
  .vol-card-body > div {
    border-right: none !important;
    border-bottom: 1px solid var(--border);
  }
  .vol-card-body > div:last-child {
    border-bottom: none;
  }
}
</style>

<script>
function switchTab(tab) {
  document.getElementById('panel-students').style.display = tab === 'students' ? 'block' : 'none';
  document.getElementById('panel-history').style.display = tab === 'history' ? 'block' : 'none';
  document.querySelectorAll('.vol-tab').forEach(function(t) {
    t.classList.remove('active');
    t.style.color = 'var(--muted)';
    t.style.borderBottomColor = 'transparent';
  });
  var active = document.getElementById('tab-' + tab);
  active.classList.add('active');
  active.style.color = 'var(--primary)';
  active.style.borderBottomColor = 'var(--primary)';
}
switchTab('students');

function toggleUpload(select) {
  const box = select.closest("form").querySelector(".proof-upload");
  box.style.display = select.value === "Completed" ? "block" : "none";
}

function filterRisk(val) {
  document.querySelectorAll("#studentCards > .col-12").forEach(function(card) {
    card.style.display = (val === "all" || (card.dataset.risk || '').trim() === val) ? "" : "none";
  });
}

// STT (Speech-to-Text) for notes field
var _volRecognition = null;
function volSTT(btn) {
  var SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
  if (!SpeechRecognition) { alert('Speech recognition is not supported. Please use Chrome.'); return; }

  // If already listening, stop
  if (btn.classList.contains('listening') && _volRecognition) {
    _volRecognition.stop();
    return;
  }

  var textarea = btn.closest('div').querySelector('textarea');
  if (!textarea) return;

  _volRecognition = new SpeechRecognition();
  var langCookie = (document.cookie.match(/(^| )edudrop_lang=([^;]+)/) || [])[2] || 'en';
  var sttMap = {'en':'en-IN','hi':'hi-IN','bn':'bn-IN','te':'te-IN','mr':'mr-IN','ta':'ta-IN','gu':'gu-IN','kn':'kn-IN','ml':'ml-IN','pa':'pa-IN','or':'or-IN','as':'as-IN','ur':'ur-IN','sa':'sa-IN','ne':'ne-NP','sd':'sd-IN','ks':'ks-IN','doi':'doi-IN','mai':'mai-IN','mni-Mtei':'mni-IN','sat':'sat-IN','gom':'kok-IN'};
  _volRecognition.lang = sttMap[langCookie] || 'en-IN';
  _volRecognition.interimResults = false;
  _volRecognition.maxAlternatives = 1;

  _volRecognition.onstart = function() {
    btn.classList.add('listening');
    btn.innerHTML = '<i class="bi bi-mic-mute-fill"></i>';
  };
  _volRecognition.onresult = function(e) {
    var transcript = e.results[0][0].transcript;
    textarea.value = textarea.value ? textarea.value + ' ' + transcript : transcript;
  };
  _volRecognition.onend = function() {
    btn.classList.remove('listening');
    btn.innerHTML = '<i class="bi bi-mic-fill"></i>';
    _volRecognition = null;
  };
  _volRecognition.onerror = function(e) {
    btn.classList.remove('listening');
    btn.innerHTML = '<i class="bi bi-mic-fill"></i>';
    if (e.error !== 'aborted') alert('Voice error: ' + e.error);
    _volRecognition = null;
  };
  _volRecognition.start();
}

// TTS for volunteer dashboard fields
var _volTtsAudio = null;
function volSpeak(btn) {
  // Find the text from sibling .tts-text or parent's .tts-text
  var textEl = btn.closest('div').querySelector('.tts-text') || btn.parentElement.querySelector('.tts-text');
  if (!textEl) return;
  var text = textEl.textContent.trim();
  if (!text || text === '-') return;

  // Stop if already playing
  if (_volTtsAudio) { _volTtsAudio.pause(); _volTtsAudio = null; btn.innerHTML = '<i class="bi bi-volume-up-fill"></i>'; return; }
  if (window.speechSynthesis && window.speechSynthesis.speaking) { window.speechSynthesis.cancel(); btn.innerHTML = '<i class="bi bi-volume-up-fill"></i>'; return; }

  // Check language
  var langCookie = (document.cookie.match(/(^| )edudrop_lang=([^;]+)/) || [])[2] || 'en';
  if (langCookie === 'en') {
    var utter = new SpeechSynthesisUtterance(text);
    utter.lang = 'en-IN';
    utter.rate = 0.9;
    btn.innerHTML = '<i class="bi bi-pause-fill"></i>';
    utter.onend = function() { btn.innerHTML = '<i class="bi bi-volume-up-fill"></i>'; };
    utter.onerror = function() { btn.innerHTML = '<i class="bi bi-volume-up-fill"></i>'; };
    window.speechSynthesis.speak(utter);
  } else {
    // Use Google TTS proxy
    var gttsMap = {'hi':'hi','bn':'bn','te':'te','mr':'mr','ta':'ta','gu':'gu','kn':'kn','ml':'ml','pa':'pa','or':'or','as':'as','ur':'ur','sa':'sa','ne':'ne','sd':'sd','ks':'hi','doi':'hi','mai':'hi','mni-Mtei':'bn','sat':'hi','gom':'hi'};
    var tl = gttsMap[langCookie] || 'en';
    var chunks = [];
    var t = text;
    while (t.length > 0) {
      if (t.length <= 200) { chunks.push(t); break; }
      var cut = t.lastIndexOf('.', 200);
      if (cut < 50) cut = t.lastIndexOf(' ', 200);
      if (cut < 50) cut = 200;
      chunks.push(t.substring(0, cut + 1));
      t = t.substring(cut + 1).trim();
    }
    var idx = 0;
    btn.innerHTML = '<i class="bi bi-pause-fill"></i>';
    function playNext() {
      if (idx >= chunks.length) { btn.innerHTML = '<i class="bi bi-volume-up-fill"></i>'; _volTtsAudio = null; return; }
      _volTtsAudio = new Audio('/api/tts?tl=' + tl + '&q=' + encodeURIComponent(chunks[idx]));
      _volTtsAudio.onended = function() { idx++; playNext(); };
      _volTtsAudio.onerror = function() { btn.innerHTML = '<i class="bi bi-volume-up-fill"></i>'; _volTtsAudio = null; };
      _volTtsAudio.play();
    }
    playNext();
  }
}
</script>

{% endblock %}