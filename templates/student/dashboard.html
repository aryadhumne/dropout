{% extends "base.html" %}
{% block title %}Student Dashboard - EduDrop{% endblock %}

{% block head %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{% endblock %}

{% block page_title %}Student Dashboard{% endblock %}

{% block sidebar %}
<a href="#" class="active" onclick="showSection('studentInfo',this);return false;"><i class="bi bi-person"></i><span>Student Info</span></a>
<a href="#" onclick="showSection('attendance',this);return false;"><i class="bi bi-bar-chart"></i><span>Attendance</span></a>
<a href="#" onclick="showSection('alerts',this);return false;"><i class="bi bi-exclamation-triangle"></i><span>Alerts</span></a>
<a href="#" onclick="showSection('feedback',this);return false;"><i class="bi bi-star"></i><span>Feedback</span></a>
<a href="#" onclick="showSection('applyforleave',this);return false;"><i class="bi bi-calendar-check"></i><span>Apply for Leave</span></a>
{% endblock %}

{% block topbar_right %}
{% if performance %}
{% set p = performance[0] %}
{% if p.risk_score|default(0)|int >= 60 or p.risk_status == 'At Risk' %}
<span class="badge-danger" style="font-size:0.75rem;padding:4px 10px;">At Risk</span>
{% elif p.risk_score|default(0)|int >= 30 %}
<span class="badge-warning" style="font-size:0.75rem;padding:4px 10px;">Medium Risk</span>
{% else %}
<span class="badge-success" style="font-size:0.75rem;padding:4px 10px;">Safe</span>
{% endif %}
{% endif %}
{% endblock %}

{% block content %}

{% if performance %}
{% set p = performance[0] %}

<!-- Student Info Section -->
<div id="studentInfo" class="dashboard-section">
  <h4 style="font-weight:600;margin-bottom:20px;">Welcome, {{ p.name }}</h4>

  <div class="row g-4 mb-4">
    <!-- Left: Academic & Personal Details -->
    <div class="col-lg-7">
      <div class="card" style="height:100%;">
        <h6 style="font-weight:600;margin-bottom:16px;"><i class="bi bi-mortarboard" style="margin-right:6px;color:var(--accent);"></i>Academic Details</h6>
        <table style="width:100%;font-size:0.9rem;border-collapse:separate;border-spacing:0 8px;">
          <tr>
            <td style="color:var(--muted);width:130px;padding:4px 0;">Standard</td>
            <td style="font-weight:600;padding:4px 0;">{{ p.standard }}</td>
            <td style="color:var(--muted);width:130px;padding:4px 0;">Division</td>
            <td style="font-weight:600;padding:4px 0;">{{ p.division }}</td>
          </tr>
          <tr>
            <td style="color:var(--muted);padding:4px 0;">Roll No</td>
            <td style="font-weight:600;padding:4px 0;">{{ p.roll_no or p.roll }}</td>
            <td style="color:var(--muted);padding:4px 0;">Gender</td>
            <td style="font-weight:600;padding:4px 0;">{{ p.gender or 'N/A' }}</td>
          </tr>
          <tr>
            <td style="color:var(--muted);padding:4px 0;">Email</td>
            <td colspan="3" style="font-weight:600;padding:4px 0;">{{ p.email or 'N/A' }}</td>
          </tr>
          <tr>
            <td style="color:var(--muted);padding:4px 0;">Month</td>
            <td style="font-weight:600;padding:4px 0;">{{ p.month or 'N/A' }}</td>
            <td style="color:var(--muted);padding:4px 0;">Risk Status</td>
            <td style="font-weight:600;padding:4px 0;">
              {% if p.risk_status == 'At Risk' or p.risk == 'High' %}
                <span class="badge-danger">{{ p.risk_status or p.risk }}</span>
              {% elif p.risk == 'Medium' %}
                <span class="badge-warning">{{ p.risk_status or p.risk }}</span>
              {% else %}
                <span class="badge-success">{{ p.risk_status or p.risk or 'N/A' }}</span>
              {% endif %}
            </td>
          </tr>
          {% if p.risk_reason %}
          <tr>
            <td style="color:var(--muted);padding:4px 0;">Risk Reason</td>
            <td colspan="3" style="font-weight:500;padding:4px 0;color:var(--danger);font-size:0.85rem;">{{ p.risk_reason }}</td>
          </tr>
          {% endif %}
        </table>
      </div>
    </div>

    <!-- Right: Performance Overview -->
    <div class="col-lg-5">
      <div class="card" style="height:100%;">
        <h6 style="font-weight:600;margin-bottom:16px;"><i class="bi bi-graph-up" style="margin-right:6px;color:var(--accent);"></i>Performance Overview</h6>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
          <div style="background:var(--bg);border-radius:10px;padding:14px;text-align:center;">
            <div style="font-size:0.78rem;color:var(--muted);margin-bottom:4px;">Attendance</div>
            <div style="font-size:1.5rem;font-weight:700;color:{% if p.attendance|default(p.avg|default(0))|int < 75 %}var(--danger){% else %}var(--text){% endif %};">{{ p.attendance|default(p.avg|default(0))|int }}%</div>
          </div>
          <div style="background:var(--bg);border-radius:10px;padding:14px;text-align:center;">
            <div style="font-size:0.78rem;color:var(--muted);margin-bottom:4px;">Monthly Test</div>
            <div style="font-size:1.5rem;font-weight:700;">{{ p.monthly_test_score|default(0)|int }}</div>
          </div>
          <div style="background:var(--bg);border-radius:10px;padding:14px;text-align:center;">
            <div style="font-size:0.78rem;color:var(--muted);margin-bottom:4px;">Assignment</div>
            <div style="font-size:1.5rem;font-weight:700;">{{ p.assignment|default(0)|int }}</div>
          </div>
          <div style="background:var(--bg);border-radius:10px;padding:14px;text-align:center;">
            <div style="font-size:0.78rem;color:var(--muted);margin-bottom:4px;">Quiz</div>
            <div style="font-size:1.5rem;font-weight:700;">{{ p.quiz|default(0)|int }}</div>
          </div>
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px;margin-top:12px;">
          <div style="background:var(--bg);border-radius:10px;padding:12px;text-align:center;">
            <div style="font-size:0.75rem;color:var(--muted);margin-bottom:2px;">Risk Score</div>
            <div style="font-size:1.2rem;font-weight:700;color:{% if p.risk_score|default(0)|int >= 60 %}var(--danger){% elif p.risk_score|default(0)|int >= 30 %}var(--warning){% else %}var(--success){% endif %};">{{ p.risk_score|default(0)|int }}</div>
          </div>
          <div style="background:var(--bg);border-radius:10px;padding:12px;text-align:center;">
            <div style="font-size:0.75rem;color:var(--muted);margin-bottom:2px;">Performance</div>
            <div style="font-size:1.2rem;font-weight:700;">{{ ((p.attendance|default(p.avg|default(0))|int + p.assignment|default(0)|int + p.quiz|default(0)|int)//3) }}%</div>
          </div>
          <div style="background:var(--bg);border-radius:10px;padding:12px;text-align:center;">
            <div style="font-size:0.75rem;color:var(--muted);margin-bottom:2px;">Risk Level</div>
            <div style="font-size:1.2rem;font-weight:700;color:{% if p.risk_status == 'At Risk' or p.risk == 'High' %}var(--danger){% elif p.risk == 'Medium' %}var(--warning){% else %}var(--success){% endif %};">{{ p.risk_status or p.risk or 'Safe' }}</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  {% if p.parent_name %}
  <div class="card mb-4">
    <h6 style="font-weight:600;margin-bottom:16px;"><i class="bi bi-people" style="margin-right:6px;color:var(--accent);"></i>Parent / Guardian Details</h6>
    <table style="width:100%;font-size:0.9rem;border-collapse:separate;border-spacing:0 8px;">
      <tr>
        <td style="color:var(--muted);width:130px;padding:4px 0;">Name</td>
        <td style="font-weight:600;padding:4px 0;">{{ p.parent_name }}</td>
        <td style="color:var(--muted);width:130px;padding:4px 0;">Phone</td>
        <td style="font-weight:600;padding:4px 0;">{{ p.parent_phone or 'N/A' }}</td>
      </tr>
      <tr>
        <td style="color:var(--muted);padding:4px 0;">Alt. Phone</td>
        <td style="font-weight:600;padding:4px 0;">{{ p.parent_alt_phone or 'N/A' }}</td>
        {% if p.parent_address %}
        <td style="color:var(--muted);padding:4px 0;">Address</td>
        <td style="font-weight:600;padding:4px 0;">{{ p.parent_address }}</td>
        {% else %}
        <td></td><td></td>
        {% endif %}
      </tr>
    </table>
  </div>
  {% endif %}
</div>

<!-- Attendance Section -->
<div id="attendance" class="dashboard-section" style="display:none;">
  <div class="card mb-4 text-center">
    <h6 style="font-weight:600;margin-bottom:16px;">Attendance Progress</h6>
    <div style="width:170px;height:170px;border-radius:50%;background:conic-gradient(var(--accent) {{ p.attendance|default(p.avg|default(0))|int }}%, var(--border) 0);display:flex;align-items:center;justify-content:center;font-size:1.8rem;font-weight:700;margin:0 auto;color:var(--text);">
      {{ p.attendance|default(p.avg|default(0))|int }}%
    </div>
  </div>
  <div class="card">
    <h6 style="font-weight:600;margin-bottom:16px;">Attendance Chart</h6>
    <canvas id="attendanceChart"></canvas>
  </div>
</div>

<!-- Alerts Section -->
<div id="alerts" class="dashboard-section" style="display:none;">
  <div class="card">
    <h6 style="font-weight:600;margin-bottom:16px;">Alerts</h6>
    {% if p.risk_reason %}
    <div style="padding:12px;background:rgba(239,68,68,0.1);border-left:4px solid var(--danger);border-radius:8px;margin-bottom:12px;color:var(--danger);">
      <strong>AI Risk Flags:</strong> {{ p.risk_reason }}
    </div>
    {% endif %}
    {% if (p.attendance|default(p.avg|default(0))|int) < 75 %}
    <div style="padding:12px;background:rgba(239,68,68,0.1);border-left:4px solid var(--danger);border-radius:8px;margin-bottom:12px;color:var(--danger);">
      Attendance below 75% - Please improve your attendance.
    </div>
    {% endif %}
    {% if p.assignment|default(0)|int < 50 %}
    <div style="padding:12px;background:rgba(245,158,11,0.1);border-left:4px solid var(--warning);border-radius:8px;margin-bottom:12px;color:var(--warning);">
      Low assignment submission - Submit your pending assignments.
    </div>
    {% endif %}
    {% if p.quiz|default(0)|int < 50 %}
    <div style="padding:12px;background:rgba(245,158,11,0.1);border-left:4px solid var(--warning);border-radius:8px;margin-bottom:12px;color:var(--warning);">
      Low quiz performance - Focus on improving quiz scores.
    </div>
    {% endif %}
    {% if p.monthly_test_score|default(0)|int < 35 %}
    <div style="padding:12px;background:rgba(239,68,68,0.1);border-left:4px solid var(--danger);border-radius:8px;margin-bottom:12px;color:var(--danger);">
      Monthly test score below 35 - Needs immediate improvement.
    </div>
    {% endif %}
    {% if (p.attendance|default(p.avg|default(0))|int) >= 75 and p.assignment|default(0)|int >= 50 and p.quiz|default(0)|int >= 50 and p.monthly_test_score|default(100)|int >= 35 %}
    <div style="padding:12px;background:rgba(34,197,94,0.1);border-left:4px solid var(--success);border-radius:8px;color:var(--success);">
      Great job! No alerts at the moment.
    </div>
    {% endif %}
  </div>
</div>

<!-- Feedback Section -->
<div id="feedback" class="dashboard-section" style="display:none;">
  <div class="card">
    <h6 style="font-weight:600;margin-bottom:16px;">Submit Feedback</h6>
    <form method="POST" action="/student/feedback">
      <div class="mb-3">
        <label class="form-label">About Teacher</label>
        <select name="teacher_name" class="form-control" required>
          <option value="">Select a teacher</option>
          {% for t in teachers %}
          <option value="{{ t.name }}">{{ t.name }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="mb-3">
        <label class="form-label">Your Feedback</label>
        <textarea name="feedback" class="form-control" rows="4" placeholder="Share your thoughts about this teacher..." required></textarea>
      </div>
      <button type="submit" class="btn btn-primary">Submit Feedback</button>
    </form>
  </div>
</div>

<!-- Apply for Leave Section -->
<div id="applyforleave" class="dashboard-section" style="display:none;">
  <div class="card">
    <h6 style="font-weight:600;margin-bottom:16px;">Apply for Leave</h6>
    <form method="POST" action="/student/leave">
      <div class="mb-3">
        <label class="form-label">Leave Date</label>
        <input type="date" name="leave_date" class="form-control" required>
      </div>
      <div class="mb-3">
        <label class="form-label">Reason</label>
        <textarea name="reason" class="form-control" rows="3" placeholder="Reason for leave..." required></textarea>
      </div>
      <button type="submit" class="btn btn-primary">Apply</button>
    </form>
  </div>
</div>

{% endif %}

<!-- AI Chatbot Widget â€” commented out until Gemini API key quota is available
<div id="chatbot-toggle" onclick="toggleChat()" style="position:fixed;bottom:24px;right:24px;width:56px;height:56px;border-radius:50%;background:linear-gradient(135deg,#e72191,#ff951a);color:#fff;display:flex;align-items:center;justify-content:center;cursor:pointer;box-shadow:0 4px 20px rgba(231,33,145,0.4);z-index:1000;transition:transform 0.2s;" onmouseover="this.style.transform='scale(1.1)'" onmouseout="this.style.transform='scale(1)'">
  <i class="bi bi-robot" style="font-size:1.5rem;"></i>
</div>
<div id="chatbot-panel" style="display:none;position:fixed;bottom:90px;right:24px;width:360px;max-height:480px;background:#fff;border-radius:16px;box-shadow:0 8px 40px rgba(0,0,0,0.15);z-index:1000;overflow:hidden;font-family:'Plus Jakarta Sans',sans-serif;">
  <div style="background:linear-gradient(135deg,#e72191,#ff951a);color:#fff;padding:14px 18px;display:flex;align-items:center;justify-content:space-between;">
    <div style="display:flex;align-items:center;gap:8px;">
      <i class="bi bi-robot" style="font-size:1.2rem;"></i>
      <div><div style="font-weight:700;font-size:0.95rem;">EduBot</div><div style="font-size:0.7rem;opacity:0.85;">AI Academic Counselor</div></div>
    </div>
    <button onclick="toggleChat()" style="background:none;border:none;color:#fff;font-size:1.2rem;cursor:pointer;padding:0;"><i class="bi bi-x-lg"></i></button>
  </div>
  <div id="chat-messages" style="height:320px;overflow-y:auto;padding:14px;display:flex;flex-direction:column;gap:10px;">
    <div style="background:var(--bg,#f8f9fa);padding:10px 14px;border-radius:12px 12px 12px 4px;max-width:85%;font-size:0.85rem;color:var(--text,#1e293b);">
      Hi! I'm <strong>EduBot</strong>, your AI academic counselor. Ask me anything about your studies, performance, or study tips!
    </div>
  </div>
  <div style="padding:10px 14px;border-top:1px solid #e5e7eb;display:flex;gap:8px;">
    <input type="text" id="chat-input" placeholder="Type your message..." style="flex:1;border:1px solid #e5e7eb;border-radius:8px;padding:8px 12px;font-size:0.85rem;font-family:inherit;outline:none;" onkeydown="if(event.key==='Enter')sendChat()">
    <button onclick="sendChat()" style="background:linear-gradient(135deg,#e72191,#ff951a);color:#fff;border:none;border-radius:8px;padding:8px 14px;cursor:pointer;font-size:0.9rem;"><i class="bi bi-send-fill"></i></button>
  </div>
</div>
<script>
function toggleChat(){const p=document.getElementById('chatbot-panel');p.style.display=p.style.display==='none'?'block':'none';}
function sendChat(){const i=document.getElementById('chat-input');const m=i.value.trim();if(!m)return;const msgs=document.getElementById('chat-messages');const u=document.createElement('div');u.style.cssText='background:linear-gradient(135deg,#e72191,#ff951a);color:#fff;padding:10px 14px;border-radius:12px 12px 4px 12px;max-width:85%;font-size:0.85rem;align-self:flex-end;';u.textContent=m;msgs.appendChild(u);i.value='';msgs.scrollTop=msgs.scrollHeight;const t=document.createElement('div');t.id='typing-indicator';t.style.cssText='background:#f1f5f9;padding:10px 14px;border-radius:12px 12px 12px 4px;max-width:85%;font-size:0.85rem;color:#94a3b8;';t.innerHTML='Thinking...';msgs.appendChild(t);msgs.scrollTop=msgs.scrollHeight;fetch('/api/chat',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({message:m})}).then(r=>r.json()).then(d=>{const tp=document.getElementById('typing-indicator');if(tp)tp.remove();const b=document.createElement('div');b.style.cssText='background:#f1f5f9;padding:10px 14px;border-radius:12px 12px 12px 4px;max-width:85%;font-size:0.85rem;color:#1e293b;';b.textContent=d.response||'Sorry, I could not respond.';msgs.appendChild(b);msgs.scrollTop=msgs.scrollHeight;}).catch(()=>{const tp=document.getElementById('typing-indicator');if(tp)tp.remove();const e=document.createElement('div');e.style.cssText='background:#fef2f2;padding:10px 14px;border-radius:12px 12px 12px 4px;max-width:85%;font-size:0.85rem;color:#ef4444;';e.textContent='Network error. Please try again.';msgs.appendChild(e);msgs.scrollTop=msgs.scrollHeight;});}
</script>
<style>@keyframes pulse{0%,100%{opacity:1}50%{opacity:0.4}}#chatbot-panel::-webkit-scrollbar{width:4px}#chat-messages::-webkit-scrollbar{width:4px}#chat-messages::-webkit-scrollbar-thumb{background:#cbd5e1;border-radius:4px}</style>
END AI Chatbot Widget -->

<script>
function showSection(id, el) {
  document.querySelectorAll(".dashboard-section").forEach(s => s.style.display = "none");
  document.getElementById(id).style.display = "block";
  document.querySelectorAll(".sidebar a").forEach(a => a.classList.remove("active"));
  if (el) el.classList.add("active");
}

document.addEventListener("DOMContentLoaded", function() {
  const ctx = document.getElementById("attendanceChart");
  if (ctx) {
    new Chart(ctx, {
      type: "bar",
      data: { labels: ["Attendance"], datasets: [{ label: "Attendance %", data: [{{ p.attendance|default(p.avg|default(0))|int }}], backgroundColor: "#e72191" }] },
      options: { scales: { y: { beginAtZero: true, max: 100 } }, responsive: true }
    });
  }
});
</script>

{% endblock %}
