<!-- AI Chatbot Widget -->
<div id="chatbot-toggle" class="chatbot-toggle" onclick="toggleChat()">
  <i class="bi bi-robot"></i>
</div>
<div id="chatbot-panel" class="chatbot-panel">
  <div class="chatbot-header">
    <div style="display:flex;align-items:center;gap:10px;">
      <i class="bi bi-robot" style="font-size:1.2rem;"></i>
      <div>
        <div style="font-weight:700;font-size:0.95rem;">EduBot</div>
        <div style="font-size:0.7rem;opacity:0.85;">{{ chatbot_subtitle }}</div>
      </div>
    </div>
    <button onclick="toggleChat()" style="background:none;border:none;color:#fff;font-size:1.2rem;cursor:pointer;padding:0;"><i class="bi bi-x-lg"></i></button>
  </div>
  <div id="chat-messages" class="chatbot-messages">
    <div class="chat-msg chat-msg-bot">
      {{ chatbot_greeting }}
    </div>
  </div>
  <div class="chatbot-input-row">
    <button id="mic-btn" onclick="toggleVoiceInput()" title="Voice input"><i class="bi bi-mic-fill"></i></button>
    <input type="text" id="chat-input" placeholder="Type or speak..." onkeydown="if(event.key==='Enter')sendChat()">
    <button onclick="sendChat()"><i class="bi bi-send-fill"></i></button>
  </div>
</div>

<script>
// Fixed role value — never affected by Google Translate
var _chatbotRole = "{{ chatbot_role }}";

// Language map: code → {name, sttCode, ttsLang}
var _langMap = {
  'en': {name:'English', stt:'en-IN', tts:'en'},
  'hi': {name:'Hindi', stt:'hi-IN', tts:'hi'},
  'bn': {name:'Bengali', stt:'bn-IN', tts:'bn'},
  'te': {name:'Telugu', stt:'te-IN', tts:'te'},
  'mr': {name:'Marathi', stt:'mr-IN', tts:'mr'},
  'ta': {name:'Tamil', stt:'ta-IN', tts:'ta'},
  'gu': {name:'Gujarati', stt:'gu-IN', tts:'gu'},
  'kn': {name:'Kannada', stt:'kn-IN', tts:'kn'},
  'ml': {name:'Malayalam', stt:'ml-IN', tts:'ml'},
  'pa': {name:'Punjabi', stt:'pa-IN', tts:'pa'},
  'or': {name:'Odia', stt:'or-IN', tts:'or'},
  'as': {name:'Assamese', stt:'as-IN', tts:'as'},
  'ur': {name:'Urdu', stt:'ur-IN', tts:'ur'},
  'sa': {name:'Sanskrit', stt:'sa-IN', tts:'sa'},
  'ne': {name:'Nepali', stt:'ne-NP', tts:'ne'},
  'sd': {name:'Sindhi', stt:'sd-IN', tts:'sd'},
  'ks': {name:'Kashmiri', stt:'ks-IN', tts:'ks'},
  'doi':{name:'Dogri', stt:'doi-IN', tts:'hi'},
  'mai':{name:'Maithili', stt:'mai-IN', tts:'hi'},
  'mni-Mtei':{name:'Manipuri', stt:'mni-IN', tts:'bn'},
  'sat':{name:'Santali', stt:'sat-IN', tts:'hi'},
  'gom':{name:'Konkani', stt:'kok-IN', tts:'hi'}
};

function _getSelectedLang() {
  var match = document.cookie.match(/(^| )edudrop_lang=([^;]+)/);
  return match ? match[2] : 'en';
}

function _getLangName() {
  var code = _getSelectedLang();
  return (_langMap[code] || _langMap['en']).name;
}

function toggleChat() {
  var p = document.getElementById('chatbot-panel');
  var t = document.getElementById('chatbot-toggle');
  if (p.classList.contains('open')) {
    p.classList.remove('open');
    t.classList.remove('active');
  } else {
    p.classList.add('open');
    t.classList.add('active');
    document.getElementById('chat-input').focus();
  }
}

function sendChat() {
  var input = document.getElementById('chat-input');
  var msg = input.value.trim();
  if (!msg) return;
  var msgs = document.getElementById('chat-messages');
  var lang = _getSelectedLang();

  var u = document.createElement('div');
  u.className = 'chat-msg chat-msg-user';
  u.textContent = msg;
  msgs.appendChild(u);
  input.value = '';
  msgs.scrollTop = msgs.scrollHeight;

  var t = document.createElement('div');
  t.id = 'typing-indicator';
  t.className = 'chat-msg chat-msg-bot';
  t.style.color = '#94a3b8';
  t.innerHTML = '<i class="bi bi-three-dots" style="animation:pulse 1.2s infinite;"></i> Thinking...';
  msgs.appendChild(t);
  msgs.scrollTop = msgs.scrollHeight;

  fetch('/api/chat', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    credentials: 'same-origin',
    body: JSON.stringify({message: msg, role: _chatbotRole, lang: lang})
  })
  .then(function(r) { return r.json(); })
  .then(function(d) {
    var tp = document.getElementById('typing-indicator');
    if (tp) tp.remove();
    var b = document.createElement('div');
    b.className = 'chat-msg chat-msg-bot';
    var txt = d.response || d.error || 'Sorry, I could not respond.';
    b.innerHTML = '<span class="bot-text">' + txt.replace(/</g,'&lt;') + '</span> <button class="tts-btn" onclick="speakText(this)" title="Listen"><i class="bi bi-volume-up-fill"></i></button>';
    msgs.appendChild(b);
    msgs.scrollTop = msgs.scrollHeight;
  })
  .catch(function() {
    var tp = document.getElementById('typing-indicator');
    if (tp) tp.remove();
    var e = document.createElement('div');
    e.className = 'chat-msg chat-msg-bot';
    e.style.background = '#fef2f2';
    e.style.color = '#ef4444';
    e.textContent = 'Network error. Please try again.';
    msgs.appendChild(e);
    msgs.scrollTop = msgs.scrollHeight;
  });
}

// --- Text-to-Speech ---
var _ttsAudio = null;

// Google Translate TTS language codes (some differ from our lang codes)
var _gttsLangMap = {
  'en':'en', 'hi':'hi', 'bn':'bn', 'te':'te', 'mr':'mr', 'ta':'ta',
  'gu':'gu', 'kn':'kn', 'ml':'ml', 'pa':'pa', 'or':'or', 'as':'as',
  'ur':'ur', 'sa':'sa', 'ne':'ne', 'sd':'sd', 'ks':'hi', 'doi':'hi',
  'mai':'hi', 'mni-Mtei':'bn', 'sat':'hi', 'gom':'hi'
};

function _speakWithGoogleTTS(text, lang, btn) {
  // Google Translate TTS supports ~200 chars per request; split if longer
  var chunks = [];
  while (text.length > 0) {
    if (text.length <= 200) {
      chunks.push(text);
      break;
    }
    // Find a good split point (sentence end or space)
    var cut = text.lastIndexOf('.', 200);
    if (cut < 50) cut = text.lastIndexOf(' ', 200);
    if (cut < 50) cut = 200;
    chunks.push(text.substring(0, cut + 1));
    text = text.substring(cut + 1).trim();
  }

  var ttsLang = _gttsLangMap[lang] || 'en';
  var idx = 0;

  function playNext() {
    if (idx >= chunks.length) {
      btn.innerHTML = '<i class="bi bi-volume-up-fill"></i>';
      _ttsAudio = null;
      return;
    }
    var url = '/api/tts?tl=' + ttsLang + '&q=' + encodeURIComponent(chunks[idx]);
    _ttsAudio = new Audio(url);
    _ttsAudio.onended = function() { idx++; playNext(); };
    _ttsAudio.onerror = function() { btn.innerHTML = '<i class="bi bi-volume-up-fill"></i>'; _ttsAudio = null; };
    _ttsAudio.play();
  }

  btn.innerHTML = '<i class="bi bi-pause-fill"></i>';
  playNext();
}

function _speakWithWebAPI(text, btn) {
  var utter = new SpeechSynthesisUtterance(text);
  utter.lang = 'en-IN';
  // Prefer high-quality English voices
  var voices = window.speechSynthesis.getVoices();
  var preferred = ['Google UK English Female', 'Google US English', 'Samantha', 'Karen', 'Daniel'];
  for (var j = 0; j < preferred.length; j++) {
    for (var k = 0; k < voices.length; k++) {
      if (voices[k].name.indexOf(preferred[j]) !== -1) { utter.voice = voices[k]; break; }
    }
    if (utter.voice) break;
  }
  utter.rate = 0.9;
  utter.pitch = 1.05;
  utter.volume = 1;
  btn.innerHTML = '<i class="bi bi-pause-fill"></i>';
  utter.onend = function() { btn.innerHTML = '<i class="bi bi-volume-up-fill"></i>'; };
  utter.onerror = function() { btn.innerHTML = '<i class="bi bi-volume-up-fill"></i>'; };
  window.speechSynthesis.speak(utter);
}

// Preload voices
if (window.speechSynthesis) window.speechSynthesis.getVoices();

function speakText(btn) {
  var text = btn.parentElement.querySelector('.bot-text').textContent;

  // Stop if already playing
  if (_ttsAudio) {
    _ttsAudio.pause();
    _ttsAudio = null;
    btn.innerHTML = '<i class="bi bi-volume-up-fill"></i>';
    return;
  }
  if (window.speechSynthesis.speaking) {
    window.speechSynthesis.cancel();
    btn.innerHTML = '<i class="bi bi-volume-up-fill"></i>';
    return;
  }

  var lang = _getSelectedLang();
  if (lang === 'en') {
    _speakWithWebAPI(text, btn);
  } else {
    _speakWithGoogleTTS(text, lang, btn);
  }
}

// --- Speech-to-Text ---
var _recognition = null;
var _isListening = false;

function toggleVoiceInput() {
  var SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
  if (!SpeechRecognition) {
    alert('Speech recognition is not supported in your browser. Please use Chrome.');
    return;
  }
  var micBtn = document.getElementById('mic-btn');
  if (_isListening && _recognition) {
    _recognition.stop();
    return;
  }
  _recognition = new SpeechRecognition();
  // Use the selected language for speech recognition
  var lang = _getSelectedLang();
  _recognition.lang = (_langMap[lang] || _langMap['en']).stt;
  _recognition.interimResults = false;
  _recognition.maxAlternatives = 1;

  _recognition.onstart = function() {
    _isListening = true;
    micBtn.classList.add('listening');
    micBtn.innerHTML = '<i class="bi bi-mic-mute-fill"></i>';
  };
  _recognition.onresult = function(e) {
    var transcript = e.results[0][0].transcript;
    document.getElementById('chat-input').value = transcript;
    sendChat();
  };
  _recognition.onend = function() {
    _isListening = false;
    micBtn.classList.remove('listening');
    micBtn.innerHTML = '<i class="bi bi-mic-fill"></i>';
    _recognition = null;
  };
  _recognition.onerror = function(e) {
    _isListening = false;
    micBtn.classList.remove('listening');
    micBtn.innerHTML = '<i class="bi bi-mic-fill"></i>';
    if (e.error !== 'aborted') alert('Voice error: ' + e.error);
    _recognition = null;
  };
  _recognition.start();
}
</script>
