{% extends 'teacher/base.html' %}
{% block title %}Teacher Dashboard - EduDrop{% endblock %}
{% block content %}

<style>
  .chart-card-responsive {
    height: 340px;
    display: flex;
    flex-direction: column;
  }
  .chart-card-responsive .chart-wrapper {
    position: relative;
    flex: 1;
    min-height: 0;
  }
  @media (max-width: 768px) {
    .chart-card-responsive { height: 260px; }
    .risk-class-card canvas { height: 180px !important; }
    .export-pdf-btn { font-size: 0.75rem !important; padding: 5px 10px !important; }
    .export-pdf-btn .btn-text { display: none; }
    .export-pdf-btn .btn-icon { display: inline; }
  }
  @media (min-width: 769px) {
    .export-pdf-btn .btn-icon { display: none; }
  }
  @media (max-width: 480px) {
    .chart-card-responsive { height: 220px; }
  }
</style>

<!-- Summary Cards -->
<div class="row g-3 mb-4">
  <div class="col-6 col-lg-3">
    <div class="stat-card">
      <div class="stat-label">Total Students</div>
      <div class="stat-value" id="card-total">{{ total_students }}</div>
    </div>
  </div>
  <div class="col-6 col-lg-3">
    <div class="stat-card" style="border-left-color:var(--danger);">
      <div class="stat-label" style="color:var(--danger);">High Risk</div>
      <div class="stat-value" style="color:var(--danger);" id="card-high">{{ high_risk }}</div>
    </div>
  </div>
  <div class="col-6 col-lg-3">
    <div class="stat-card" style="border-left-color:var(--warning);">
      <div class="stat-label" style="color:var(--warning);">Medium Risk</div>
      <div class="stat-value" style="color:var(--warning);" id="card-medium">{{ medium_risk }}</div>
    </div>
  </div>
  <div class="col-6 col-lg-3">
    <div class="stat-card" style="border-left-color:var(--success);">
      <div class="stat-label" style="color:var(--success);">Low Risk</div>
      <div class="stat-value" style="color:var(--success);" id="card-low">{{ low_risk }}</div>
    </div>
  </div>
</div>

<!-- Charts -->
<div class="row g-3 mb-4">
  <div class="col-12 col-md-6">
    <div class="card chart-card-responsive">
      <h6 style="margin-bottom:10px;font-weight:600;">Risk Distribution</h6>
      <div class="chart-wrapper">
        <canvas id="riskPieChart"></canvas>
      </div>
    </div>
  </div>
  <div class="col-12 col-md-6">
    <div class="card chart-card-responsive">
      <h6 style="margin-bottom:10px;font-weight:600;">Risk Trend</h6>
      <div class="chart-wrapper">
        <canvas id="riskTrendChart"></canvas>
      </div>
    </div>
  </div>
</div>

<!-- Risk by Class -->
<div class="card risk-class-card mb-4">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h6 style="font-weight:600;margin:0;">Risk by Class</h6>
    <button class="btn btn-primary export-pdf-btn" onclick="exportPDF()" style="font-size:0.85rem;">
      <i class="bi bi-download"></i> <span class="btn-text">Export PDF</span><span class="btn-icon">PDF</span>
    </button>
  </div>
  <canvas id="riskByClassChart" height="120"></canvas>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<script>
const COLORS = { danger: '#ef4444', warning: '#f59e0b', success: '#22c55e', primary: '#1e1b4b', accent: '#e72191' };

{% if high_risk > 0 %}
Swal.fire({
  icon: 'warning', title: 'High Risk Alert!',
  text: '{{ high_risk }} students are in high risk category.',
  timer: 5000, timerProgressBar: true, confirmButtonColor: COLORS.accent
});
{% endif %}

const pieChart = new Chart(document.getElementById('riskPieChart'), {
  type: 'pie',
  data: {
    labels: ['Low Risk', 'Medium Risk', 'High Risk'],
    datasets: [{ data: [{{ low_risk or 0 }}, {{ medium_risk or 0 }}, {{ high_risk or 0 }}], backgroundColor: [COLORS.success, COLORS.warning, COLORS.danger] }]
  },
  options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } }
});

new Chart(document.getElementById('riskTrendChart'), {
  type: 'bar',
  data: {
    labels: {{ standards|tojson }},
    datasets: [{ label: 'At-Risk Students per Class', data: {{ standard_risk_counts|tojson }}, backgroundColor: COLORS.accent }]
  },
  options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } } }
});

new Chart(document.getElementById('riskByClassChart'), {
  type: 'bar',
  data: {
    labels: {{ standards|tojson }},
    datasets: [
      { label: 'High Risk', data: {{ std_high|tojson }}, backgroundColor: COLORS.danger },
      { label: 'Medium Risk', data: {{ std_medium|tojson }}, backgroundColor: COLORS.warning },
      { label: 'Low Risk', data: {{ std_low|tojson }}, backgroundColor: COLORS.success }
    ]
  },
  options: { responsive: true, plugins: { legend: { position: 'bottom' } }, scales: { x: { stacked: true }, y: { stacked: true, beginAtZero: true, ticks: { stepSize: 1 } } } }
});

async function exportPDF() {
  const { jsPDF } = window.jspdf;
  const canvas = await html2canvas(document.querySelector('.page-content'));
  const imgData = canvas.toDataURL("image/png");
  const pdf = new jsPDF();
  pdf.addImage(imgData, 'PNG', 10, 10, 190, 0);
  pdf.save("dashboard_report.pdf");
}
</script>

{% set chatbot_greeting = "Hi! I'm EduBot, your AI teaching assistant. Ask me about student risk levels, intervention strategies, or data insights!" %}
{% set chatbot_subtitle = "AI Teaching Assistant" %}
{% set chatbot_role = "teacher" %}
{% include 'partials/chatbot.html' %}

{% endblock %}
