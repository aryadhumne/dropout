{% extends 'teacher/base.html' %}
{% block title %}Teacher Dashboard - EduDrop{% endblock %}
{% block content %}

<!-- Summary Cards -->
<div class="row g-4 mb-4">
  <div class="col-sm-6 col-lg-3">
    <div class="stat-card">
      <div class="stat-label">Total Students</div>
      <div class="stat-value" id="card-total">{{ total_students }}</div>
    </div>
  </div>
  <div class="col-sm-6 col-lg-3">
    <div class="stat-card" style="border-left-color:var(--danger);">
      <div class="stat-label" style="color:var(--danger);">High Risk</div>
      <div class="stat-value" style="color:var(--danger);" id="card-high">{{ high_risk }}</div>
    </div>
  </div>
  <div class="col-sm-6 col-lg-3">
    <div class="stat-card" style="border-left-color:var(--warning);">
      <div class="stat-label" style="color:var(--warning);">Medium Risk</div>
      <div class="stat-value" style="color:var(--warning);" id="card-medium">{{ medium_risk }}</div>
    </div>
  </div>
  <div class="col-sm-6 col-lg-3">
    <div class="stat-card" style="border-left-color:var(--success);">
      <div class="stat-label" style="color:var(--success);">Low Risk</div>
      <div class="stat-value" style="color:var(--success);" id="card-low">{{ low_risk }}</div>
    </div>
  </div>
</div>

<!-- Charts -->
<div class="row g-4 mb-4">
  <div class="col-md-6">
    <div class="card">
      <h6 style="margin-bottom:10px;font-weight:200;">Risk Distribution</h6>
      <canvas id="riskPieChart" ></canvas>
    </div>
  </div>
  <div class="col-md-6">
    <div class="card">
      <h6 style="margin-bottom:16px;font-weight:200;">Risk Trend</h6>
      <canvas id="riskTrendChart"></canvas>
    </div>
  </div>
</div>

<!-- Predicted Risk -->
<div class="card mb-4">
  <h6 style="font-weight:600;">Predicted Next Risk</h6>
  <div style="font-size:2rem;font-weight:700;color:var(--accent);">{{ predicted_risk }}%</div>
</div>

<!-- Export & Risk Score Chart -->
<div class="card mb-4">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h6 style="font-weight:600;margin:0;">Risk Score Trend (API)</h6>
    <button class="btn btn-primary" onclick="exportPDF()" style="font-size:0.85rem;">
      <i class="bi bi-download"></i> Export PDF
    </button>
  </div>
  <canvas id="riskChart" height="100"></canvas>
</div>

<!-- Leave Requests -->
<div class="card mb-4">
  <h6 style="font-weight:600;margin-bottom:16px;"><i class="bi bi-calendar-check"></i> Student Leave Requests</h6>
  {% if leave_requests %}
  <div class="table-responsive">
    <table class="table-clean">
      <thead><tr><th>Student</th><th>Class</th><th>Division</th><th>Date</th><th>Reason</th><th>Status</th><th>Action</th></tr></thead>
      <tbody>
        {% for l in leave_requests %}
        <tr>
          <td>{{ l.student_name }}</td>
          <td>{{ l.standard or '-' }}</td>
          <td>{{ l.division or '-' }}</td>
          <td>{{ l.leave_date }}</td>
          <td>{{ l.reason }}</td>
          <td>
            {% if l.status == 'Approved' %}<span class="badge-success">Approved</span>
            {% elif l.status == 'Rejected' %}<span class="badge-danger">Rejected</span>
            {% else %}<span class="badge-warning">Pending</span>{% endif %}
          </td>
          <td>
            {% if l.status == 'Pending' %}
            <div class="d-flex gap-2">
              <form method="POST" action="/teacher/leave/{{ l.id }}/Approved" style="margin:0;">
                <button type="submit" class="btn btn-primary" style="font-size:0.75rem;padding:3px 10px;">Approve</button>
              </form>
              <form method="POST" action="/teacher/leave/{{ l.id }}/Rejected" style="margin:0;">
                <button type="submit" class="btn btn-danger" style="font-size:0.75rem;padding:3px 10px;">Reject</button>
              </form>
            </div>
            {% else %}-{% endif %}
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  {% else %}
  <p style="color:var(--muted);">No leave requests yet.</p>
  {% endif %}
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<script>
const COLORS = { danger: '#ef4444', warning: '#f59e0b', success: '#22c55e', primary: '#1e1b4b', accent: '#e72191' };

{% if high_risk > 0 %}
Swal.fire({
  icon: 'warning', title: 'High Risk Alert!',
  text: '{{ high_risk }} students are in high risk category.',
  timer: 5000, timerProgressBar: true, confirmButtonColor: COLORS.accent
});
{% endif %}

const pieChart = new Chart(document.getElementById('riskPieChart'), {
  type: 'pie',
  data: {
    labels: ['Low Risk', 'Medium Risk', 'High Risk'],
    datasets: [{ data: [{{ low_risk or 0 }}, {{ medium_risk or 0 }}, {{ high_risk or 0 }}], backgroundColor: [COLORS.success, COLORS.warning, COLORS.danger] }]
  },
  options: { responsive: true, plugins: { legend: { position: 'bottom' } } }
});

new Chart(document.getElementById('riskTrendChart'), {
  type: 'line',
  data: {
    labels: ['Week 1', 'Week 2', 'Week 3', 'Week 4'],
    datasets: [{ label: 'High Risk Trend', data: [{{ high_risk }}, {{ high_risk }}, {{ high_risk }}, {{ high_risk }}], borderColor: COLORS.danger, backgroundColor: 'rgba(239,68,68,0.1)', fill: true, tension: 0.3 }]
  },
  options: { responsive: true, plugins: { legend: { position: 'bottom' } } }
});

fetch("/teacher/risk_trend_data").then(r => r.json()).then(data => {
  new Chart(document.getElementById('riskChart'), {
    type: 'line',
    data: { labels: data.dates, datasets: [{ label: 'Risk Score Trend', data: data.scores, borderColor: COLORS.accent, backgroundColor: 'rgba(231,33,145,0.1)', fill: true, tension: 0.3 }] },
    options: { responsive: true }
  });
});

setInterval(() => {
  fetch('/teacher/dashboard_data').then(r => r.json()).then(data => {
    document.getElementById("card-total").innerText = data.total;
    document.getElementById("card-high").innerText = data.high;
    document.getElementById("card-medium").innerText = data.medium;
    document.getElementById("card-low").innerText = data.low;
    pieChart.data.datasets[0].data = [data.low, data.medium, data.high];
    pieChart.update();
  });
}, 10000);

async function exportPDF() {
  const { jsPDF } = window.jspdf;
  const canvas = await html2canvas(document.querySelector('.page-content'));
  const imgData = canvas.toDataURL("image/png");
  const pdf = new jsPDF();
  pdf.addImage(imgData, 'PNG', 10, 10, 190, 0);
  pdf.save("dashboard_report.pdf");
}
</script>

{% endblock %}
