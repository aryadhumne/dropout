{% extends "teacher/base.html" %}
{% block title %}Student Records - EduDrop{% endblock %}
{% block content %}

<h5 style="font-weight:600;margin-bottom:20px;">Student Records</h5>

<!-- Filters -->
<div class="card mb-4">
  <div class="row g-3">
    <div class="col-md-4">
      <label class="form-label">Standard</label>
      <select id="standardFilter" class="form-control">
        <option value="">All</option>
        {% for i in range(1,9) %}
        <option value="{{ i }}">{{ i }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="col-md-4">
      <label class="form-label">Division</label>
      <select id="divisionFilter" class="form-control">
        <option value="">All</option>
        <option>A</option><option>B</option><option>C</option>
        <option>D</option><option>E</option><option>F</option>
      </select>
    </div>
    <div class="col-md-4">
      <label class="form-label">Search by Name</label>
      <input type="text" id="nameSearch" class="form-control" placeholder="Enter student name">
    </div>
  </div>
</div>

<!-- Student Tables -->
{% for group, students in grouped.items() %}
<div class="card mb-4 class-card" data-class="{{ group }}">
  <h6 style="font-weight:600;margin-bottom:16px;">{{ group }}</h6>
  <div class="table-responsive">
    <table class="table-clean" style="table-layout:fixed;width:100%;">
      <colgroup>
        <col style="width:14%;"><!-- Name -->
        <col style="width:6%;"><!-- Roll -->
        <col style="width:5%;"><!-- Std -->
        <col style="width:5%;"><!-- Div -->
        <col style="width:8%;"><!-- Gender -->
        <col style="width:7%;"><!-- Risk -->
        <col style="width:16%;"><!-- Reason -->
        <col style="width:10%;"><!-- Assignment -->
        <col style="width:10%;"><!-- Behaviour -->
        <col style="width:10%;"><!-- Phone -->
        <col style="width:9%;"><!-- Address -->
      </colgroup>
      <thead>
        <tr>
          <th>Name</th>
          <th>Roll</th>
          <th>Std</th>
          <th>Div</th>
          <th>Gender</th>
          <th>Risk %</th>
          <th>Reason</th>
          <th>Assignment</th>
          <th>Behaviour</th>
          <th>Phone</th>
          <th>Address</th>
        </tr>
      </thead>
      <tbody>
        {% for s in students %}
        <tr class="student-row" id="row-{{ s.get('id') }}"
            data-id="{{ s.get('id') }}"
            data-standard="{{ s.get('standard') }}"
            data-division="{{ s.get('division') }}"
            data-name="{{ s.get('name','') | lower }}"
            style="cursor:pointer;"
            onclick="showStudentActions('{{ s.get('id') }}', '{{ s.get('name') }}')">
          <td class="td-truncate">{{ s.get("name") }}</td>
          <td>{{ s.get("roll") }}</td>
          <td>{{ s.get("standard") }}</td>
          <td>{{ s.get("division") }}</td>
          <td>{{ s.get("gender") }}</td>
          <td>
            {% set risk = s.get("risk_score", 0) %}
            {% if risk >= 60 %}
            <span class="badge-danger">{{ risk }}%</span>
            {% elif risk >= 40 %}
            <span class="badge-warning">{{ risk }}%</span>
            {% else %}
            <span class="badge-success">{{ risk }}%</span>
            {% endif %}
          </td>
          <td class="td-truncate" title="{{ s.get('risk_reason') or '-' }}">{{ s.get("risk_reason") or "-" }}</td>
          <td class="td-truncate">{{ s.get("assignment") or "-" }}</td>
          <td class="td-truncate">{{ s.get("behaviour") or "-" }}</td>
          <td class="td-truncate">{{ s.get("parent_phone") or "-" }}</td>
          <td class="td-truncate" title="{{ s.get('parent_address') or '-' }}">{{ s.get("parent_address") or "-" }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>
{% endfor %}

<script>
// Filters
document.getElementById("standardFilter").addEventListener("change", filterStudents);
document.getElementById("divisionFilter").addEventListener("change", filterStudents);
document.getElementById("nameSearch").addEventListener("input", filterStudents);

function filterStudents() {
  const standard = document.getElementById("standardFilter").value;
  const division = document.getElementById("divisionFilter").value;
  const name = document.getElementById("nameSearch").value.toLowerCase();
  const rows = document.querySelectorAll(".student-row");

  rows.forEach(row => {
    const match = (!standard || row.dataset.standard == standard) &&
                  (!division || row.dataset.division == division) &&
                  (!name || row.dataset.name.includes(name));
    row.style.display = match ? "" : "none";
  });

  // Hide class cards that have no visible rows
  document.querySelectorAll(".class-card").forEach(card => {
    const visibleRows = card.querySelectorAll(".student-row:not([style*='display: none'])");
    card.style.display = visibleRows.length ? "" : "none";
  });
}

// Click on row to show edit/delete options
function showStudentActions(studentId, studentName) {
  Swal.fire({
    title: studentName,
    text: 'What would you like to do?',
    icon: 'question',
    showCancelButton: true,
    showDenyButton: true,
    confirmButtonText: '<i class="bi bi-pencil"></i> Edit',
    denyButtonText: '<i class="bi bi-trash"></i> Delete',
    cancelButtonText: 'Cancel',
    confirmButtonColor: 'var(--primary)',
    denyButtonColor: '#ef4444',
  }).then((result) => {
    if (result.isConfirmed) {
      window.location.href = '/teacher/edit_student/' + studentId;
    } else if (result.isDenied) {
      confirmDelete(studentId, studentName);
    }
  });
}

// Delete confirmation
function confirmDelete(studentId, studentName) {
  Swal.fire({
    title: 'Are you sure?',
    text: "Delete " + studentName + "? This cannot be undone.",
    icon: 'warning',
    showCancelButton: true,
    confirmButtonColor: '#ef4444',
    cancelButtonColor: '#64748b',
    confirmButtonText: 'Yes, delete!'
  }).then((result) => {
    if (result.isConfirmed) {
      fetch('/teacher/delete_student/' + studentId, { method: "POST" })
        .then(r => r.json())
        .then(data => {
          if (data.success) {
            document.getElementById("row-" + studentId).remove();
            Swal.fire('Deleted!', studentName + ' has been removed.', 'success');
          } else {
            Swal.fire('Error', 'Something went wrong.', 'error');
          }
        });
    }
  });
}
</script>

{% endblock %}
