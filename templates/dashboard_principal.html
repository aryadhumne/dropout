{% extends "base.html" %}
{% block title %}Principal Dashboard - EduDrop{% endblock %}

{% block head %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{% endblock %}

{% block page_title %}School Dropout Monitoring{% endblock %}

{% block sidebar %}
<a href="{{ url_for('dashboard_principal') }}" class="active"><i class="bi bi-speedometer2"></i><span>Dashboard</span></a>
<a href="{{ url_for('principal_ai_analysis') }}"><i class="bi bi-cpu"></i><span>AI Analysis</span></a>
<a href="{{ url_for('principal_teachers') }}"><i class="bi bi-people"></i><span>Teacher Management</span></a>
<a href="{{ url_for('principal_feedback') }}"><i class="bi bi-chat-dots"></i><span>Student Feedback</span></a>
<a href="{{ url_for('export_high_risk_csv') }}"><i class="bi bi-file-earmark-arrow-down"></i><span>Download CSV</span></a>
<a href="{{ url_for('export_high_risk_csv') }}"><i class="bi bi-file-earmark-excel"></i><span>Download Excel</span></a>

<a href="{{ url_for('export_pdf') }}"><i class="bi bi-file-earmark-pdf"></i><span>Download PDF</span></a>
{% endblock %}

{% block content %}

<!-- Filters -->
<div class="card mb-4">
  <h6 style="font-weight:600;margin-bottom:16px;">Filters</h6>
  <form method="GET" id="filterForm">
    <div class="row g-3">
      <div class="col-md-2">
        <select name="class_filter" class="form-control" onchange="this.form.submit()">
          <option value="">All Classes</option>
          {% for i in range(1,9) %}<option value="{{i}}" {% if request.args.get('class_filter') == i|string %}selected{% endif %}>Class {{i}}</option>{% endfor %}
        </select>
      </div>
      <div class="col-md-2">
        <select name="risk_filter" class="form-control" onchange="this.form.submit()">
          <option value="">All Risk</option>
          <option value="High" {% if request.args.get('risk_filter') == 'High' %}selected{% endif %}>High</option>
          <option value="Medium" {% if request.args.get('risk_filter') == 'Medium' %}selected{% endif %}>Medium</option>
          <option value="Low" {% if request.args.get('risk_filter') == 'Low' %}selected{% endif %}>Low</option>
        </select>
      </div>
      <div class="col-md-2">
        <select name="gender_filter" class="form-control" onchange="this.form.submit()">
          <option value="">All Gender</option>
          <option value="male" {% if request.args.get('gender_filter') == 'male' %}selected{% endif %}>Male</option>
          <option value="female" {% if request.args.get('gender_filter') == 'female' %}selected{% endif %}>Female</option>
        </select>
      </div>
      <div class="col-md-2">
        <input type="number" name="min_att" class="form-control" placeholder="Min Attendance %" value="{{ request.args.get('min_att', '') }}" onchange="this.form.submit()">
      </div>
      <div class="col-md-2">
        <input type="number" name="min_marks" class="form-control" placeholder="Min Marks" value="{{ request.args.get('min_marks', '') }}" onchange="this.form.submit()">
      </div>
      <div class="col-md-2">
        <select name="date_range" class="form-control" onchange="this.form.submit()">
          <option value="">All Dates</option>
          <option value="7" {% if request.args.get('date_range') == '7' %}selected{% endif %}>Last 7 Days</option>
          <option value="30" {% if request.args.get('date_range') == '30' %}selected{% endif %}>Last 30 Days</option>
          <option value="90" {% if request.args.get('date_range') == '90' %}selected{% endif %}>Last 90 Days</option>
        </select>
      </div>
    </div>
  </form>
</div>

<!-- Analytics Cards -->
<div class="row g-3 mb-4">
  <div class="col-sm-6 col-lg-3">
    <div class="stat-card"><div class="stat-label">Total Students</div><div class="stat-value">{{ total_students }}</div></div>
  </div>
  <div class="col-sm-6 col-lg-3">
    <div class="stat-card" style="border-left-color:var(--danger);"><div class="stat-label" style="color:var(--danger);">High Risk</div><div class="stat-value" style="color:var(--danger);">{{ high_risk }}</div></div>
  </div>
  <div class="col-sm-6 col-lg-3">
    <div class="stat-card" style="border-left-color:var(--warning);"><div class="stat-label" style="color:var(--warning);">Medium Risk</div><div class="stat-value" style="color:var(--warning);">{{ medium_risk }}</div></div>
  </div>
  <div class="col-sm-6 col-lg-3">
    <div class="stat-card" style="border-left-color:var(--success);"><div class="stat-label" style="color:var(--success);">Low Risk</div><div class="stat-value" style="color:var(--success);">{{ total_students - high_risk - medium_risk }}</div></div>
  </div>
  <div class="col-sm-6 col-lg-3">
    <div class="stat-card"><div class="stat-label">Avg Attendance</div><div class="stat-value">{{ avg_attendance }}%</div></div>
  </div>
  <div class="col-sm-6 col-lg-3">
    <div class="stat-card" style="border-left-color:var(--success);"><div class="stat-label">Improved</div><div class="stat-value">{{ improved_students }}</div></div>
  </div>
  <div class="col-sm-6 col-lg-3">
    <div class="stat-card" style="border-left-color:var(--danger);"><div class="stat-label">Declined</div><div class="stat-value">{{ declined_students }}</div></div>
  </div>
  <div class="col-sm-6 col-lg-3">
    <div class="stat-card"><div class="stat-label">Total Teachers</div><div class="stat-value">{{ teachers|length }}</div></div>
  </div>
  <div class="col-sm-6 col-lg-3">
    <div class="stat-card"><div class="stat-label">Home Visits</div><div class="stat-value">{{ home_visits }}</div></div>
  </div>
  <div class="col-sm-6 col-lg-3">
    <div class="stat-card"><div class="stat-label">Parent Meetings</div><div class="stat-value">{{ parent_meetings }}</div></div>
  </div>
  <div class="col-sm-6 col-lg-3">
    <div class="stat-card"><div class="stat-label">High to Medium</div><div class="stat-value">{{ high_to_medium }}</div></div>
  </div>
  <div class="col-sm-6 col-lg-3">
    <div class="stat-card" style="border-left-color:var(--accent);"><div class="stat-label">Success Rate</div><div class="stat-value">{{ success_rate }}%</div></div>
  </div>
</div>

<!-- Charts -->
<div class="row g-4 mb-4">
  <div class="col-md-4">
    <div class="card" style="height:350px;"><h6 style="font-weight:600;margin-bottom:12px;">Risk Distribution</h6><canvas id="riskChart"></canvas></div>
  </div>
  <div class="col-md-4">
    <div class="card" style="height:350px;"><h6 style="font-weight:600;margin-bottom:12px;">Class-wise High Risk</h6><canvas id="classChart"></canvas></div>
  </div>
  <div class="col-md-4">
    <div class="card" style="height:350px;"><h6 style="font-weight:600;margin-bottom:12px;">Gender-wise Risk</h6><canvas id="genderChart"></canvas></div>
  </div>
</div>

<!-- Red Flag Students -->
<div class="card mb-4">
  <h6 style="font-weight:600;margin-bottom:16px;color:var(--danger);">Red Flag Students (Critical)</h6>
  <div class="table-responsive">
    <table class="table-clean">
      <thead><tr><th>Name</th><th>Attendance</th></tr></thead>
      <tbody>
        {% for r in red_flags %}
        <tr>
          <td>{{ r[0] }}</td>
          <td>
            {% if r[1] < 30 %}
            <span class="badge-danger">{{ r[1] }}%</span>
            {% elif r[1] < 60 %}
            <span class="badge-warning">{{ r[1] }}%</span>
            {% else %}
            <span class="badge-success">{{ r[1] }}%</span>
            {% endif %}
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<script>
const opts = { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } };

new Chart(document.getElementById("riskChart"), {
  type: "pie",
  data: { labels: ["High","Medium","Low"], datasets: [{ data: [{{high_risk}},{{medium_risk}},{{total_students - high_risk - medium_risk}}], backgroundColor: ["#ef4444","#f59e0b","#22c55e"] }] },
  options: opts
});

new Chart(document.getElementById("classChart"), {
  type: "bar",
  data: { labels: {{class_labels|tojson}}, datasets: [{ label: "High Risk", data: {{class_values|tojson}}, backgroundColor: "#e72191" }] },
  options: opts
});

new Chart(document.getElementById("genderChart"), {
  type: "doughnut",
  data: { labels: ["Boys","Girls","Other"], datasets: [{ data: [{{boys_risk}},{{girls_risk}},{{other_risk}}], backgroundColor: ["#e72191","#ff951a","#8b5cf6"] }] },
  options: opts
});
</script>

{% set chatbot_greeting = "Hi! I'm EduBot, your school analytics assistant. Ask me about school-wide trends, intervention strategies, or student data!" %}
{% set chatbot_subtitle = "School Analytics Assistant" %}
{% set chatbot_role = "principal" %}
{% include 'partials/chatbot.html' %}

{% endblock %}
