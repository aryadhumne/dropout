{% extends "base.html" %}
{% block title %}Principal Dashboard - EduDrop{% endblock %}

{% block head %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{% endblock %}

{% block page_title %}School Dropout Monitoring{% endblock %}

{% block sidebar %}
<a href="#" class="active"><i class="bi bi-speedometer2"></i><span>Dashboard</span></a>
<a href="{{ url_for('export_high_risk_csv') }}"><i class="bi bi-file-earmark-arrow-down"></i><span>Download CSV</span></a>
{% endblock %}

{% block content %}

<!-- Filters -->
<div class="card mb-4">
  <h6 style="font-weight:600;margin-bottom:16px;">Filters</h6>
  <form method="GET">
    <div class="row g-3">
      <div class="col-md-2">
        <select name="class_filter" class="form-control">
          <option value="">All Classes</option>
          {% for i in range(1,9) %}<option value="{{i}}">Class {{i}}</option>{% endfor %}
        </select>
      </div>
      <div class="col-md-2">
        <select name="risk_filter" class="form-control">
          <option value="">All Risk</option>
          <option value="High">High</option>
          <option value="Medium">Medium</option>
          <option value="Low">Low</option>
        </select>
      </div>
      <div class="col-md-2">
        <select name="gender_filter" class="form-control">
          <option value="">All Gender</option>
          <option value="male">Male</option>
          <option value="female">Female</option>
        </select>
      </div>
      <div class="col-md-2">
        <input type="number" name="min_att" class="form-control" placeholder="Min Attendance %">
      </div>
      <div class="col-md-2">
        <input type="number" name="min_marks" class="form-control" placeholder="Min Marks">
      </div>
      <div class="col-md-2">
        <select name="date_range" class="form-control">
          <option value="">All Dates</option>
          <option value="7">Last 7 Days</option>
          <option value="30">Last 30 Days</option>
          <option value="90">Last 90 Days</option>
        </select>
      </div>
    </div>
    <button type="submit" class="btn btn-primary mt-3">Apply Filters</button>
  </form>
</div>

<!-- Analytics Cards -->
<div class="row g-3 mb-4">
  <div class="col-sm-6 col-lg-3">
    <div class="stat-card"><div class="stat-label">Total Students</div><div class="stat-value">{{ total_students }}</div></div>
  </div>
  <div class="col-sm-6 col-lg-3">
    <div class="stat-card" style="border-left-color:var(--danger);"><div class="stat-label" style="color:var(--danger);">High Risk</div><div class="stat-value" style="color:var(--danger);">{{ high_risk }}</div></div>
  </div>
  <div class="col-sm-6 col-lg-3">
    <div class="stat-card" style="border-left-color:var(--warning);"><div class="stat-label" style="color:var(--warning);">Medium Risk</div><div class="stat-value" style="color:var(--warning);">{{ medium_risk }}</div></div>
  </div>
  <div class="col-sm-6 col-lg-3">
    <div class="stat-card" style="border-left-color:var(--success);"><div class="stat-label" style="color:var(--success);">Low Risk</div><div class="stat-value" style="color:var(--success);">{{ total_students - high_risk - medium_risk }}</div></div>
  </div>
  <div class="col-sm-6 col-lg-3">
    <div class="stat-card"><div class="stat-label">Avg Attendance</div><div class="stat-value">{{ avg_attendance }}%</div></div>
  </div>
  <div class="col-sm-6 col-lg-3">
    <div class="stat-card" style="border-left-color:var(--success);"><div class="stat-label">Improved</div><div class="stat-value">{{ improved_students }}</div></div>
  </div>
  <div class="col-sm-6 col-lg-3">
    <div class="stat-card" style="border-left-color:var(--danger);"><div class="stat-label">Declined</div><div class="stat-value">{{ declined_students }}</div></div>
  </div>
  <div class="col-sm-6 col-lg-3">
    <div class="stat-card"><div class="stat-label">Total Teachers</div><div class="stat-value">{{ teachers|length }}</div></div>
  </div>
  <div class="col-sm-6 col-lg-3">
    <div class="stat-card"><div class="stat-label">Home Visits</div><div class="stat-value">{{ home_visits }}</div></div>
  </div>
  <div class="col-sm-6 col-lg-3">
    <div class="stat-card"><div class="stat-label">Parent Meetings</div><div class="stat-value">{{ parent_meetings }}</div></div>
  </div>
  <div class="col-sm-6 col-lg-3">
    <div class="stat-card"><div class="stat-label">High to Medium</div><div class="stat-value">{{ high_to_medium }}</div></div>
  </div>
  <div class="col-sm-6 col-lg-3">
    <div class="stat-card" style="border-left-color:var(--accent);"><div class="stat-label">Success Rate</div><div class="stat-value">{{ success_rate }}%</div></div>
  </div>
</div>

<!-- Charts -->
<div class="row g-4 mb-4">
  <div class="col-md-4">
    <div class="card" style="height:350px;"><h6 style="font-weight:600;margin-bottom:12px;">Risk Distribution</h6><canvas id="riskChart"></canvas></div>
  </div>
  <div class="col-md-4">
    <div class="card" style="height:350px;"><h6 style="font-weight:600;margin-bottom:12px;">Class-wise High Risk</h6><canvas id="classChart"></canvas></div>
  </div>
  <div class="col-md-4">
    <div class="card" style="height:350px;"><h6 style="font-weight:600;margin-bottom:12px;">Gender-wise Risk</h6><canvas id="genderChart"></canvas></div>
  </div>
</div>

<!-- Red Flag Students -->
<div class="card mb-4">
  <h6 style="font-weight:600;margin-bottom:16px;color:var(--danger);">Red Flag Students (Critical)</h6>
  <div class="table-responsive">
    <table class="table-clean">
      <thead><tr><th>Name</th><th>Attendance</th></tr></thead>
      <tbody>
        {% for r in red_flags %}
        <tr><td>{{ r[0] }}</td><td><span class="badge-danger">{{ r[1] }}%</span></td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<!-- Student Analysis Table -->
<div class="card mb-4">
  <h6 style="font-weight:600;margin-bottom:16px;">AI Student Analysis</h6>
  <div class="table-responsive">
    <table class="table-clean">
      <thead>
        <tr><th>Roll</th><th>Name</th><th>Class</th><th>Gender</th><th>Attendance</th><th>Marks</th><th>Risk</th><th>Reason</th><th>Action</th><th>Score</th></tr>
      </thead>
      <tbody>
        {% for s in students %}
        <tr>
          <td>{{ s[0] }}</td><td>{{ s[1] }}</td><td>{{ s[2] }}</td><td>{{ s[3] }}</td>
          <td>{{ s[4] }}%</td><td>{{ s[5] }}</td>
          <td>
            {% if s[6] == 'High' %}<span class="badge-danger">{{ s[6] }}</span>
            {% elif s[6] == 'Medium' %}<span class="badge-warning">{{ s[6] }}</span>
            {% else %}<span class="badge-success">{{ s[6] }}</span>{% endif %}
          </td>
          <td>{{ s[7] }}</td><td>{{ s[8] }}</td><td>{{ s[9] }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<!-- Teacher Management -->
<div class="card mb-4">
  <h6 style="font-weight:600;margin-bottom:16px;">Teacher Management</h6>
  <form method="POST" action="{{ url_for('add_teacher') }}" class="mb-4">
    <div class="row g-3">
      <div class="col-md-3"><input type="text" name="name" class="form-control" placeholder="Teacher Name" required></div>
      <div class="col-md-3"><input type="email" name="email" class="form-control" placeholder="Email" required></div>
      <div class="col-md-3">
        <select name="assigned_class" class="form-control" required>
          {% for i in range(1,9) %}<option value="{{i}}">Class {{i}}</option>{% endfor %}
        </select>
      </div>
      <div class="col-md-3"><button type="submit" class="btn btn-primary w-100">Add Teacher</button></div>
    </div>
  </form>
  <div class="table-responsive">
    <table class="table-clean">
      <thead><tr><th>ID</th><th>Name</th><th>Email</th><th>Class</th><th>Action</th></tr></thead>
      <tbody>
        {% for t in teachers %}
        <tr>
          <td>{{ t.id }}</td><td>{{ t.name }}</td><td>{{ t.email }}</td><td>{{ t.assigned_class }}</td>
          <td><a href="{{ url_for('remove_teacher', teacher_id=t.id) }}" class="btn btn-danger" style="font-size:0.8rem;padding:4px 12px;" onclick="return confirm('Delete this teacher?')">Delete</a></td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<!-- Student Feedback -->
<div class="card mb-4">
  <h6 style="font-weight:600;margin-bottom:16px;">Student Feedback</h6>
  {% if feedbacks %}
  <div class="table-responsive">
    <table class="table-clean">
      <thead><tr><th>Student</th><th>Class</th><th>Division</th><th>About Teacher</th><th>Feedback</th><th>Sentiment</th><th>Date</th></tr></thead>
      <tbody>
        {% for f in feedbacks %}
        <tr>
          <td>{{ f.student_name }}</td>
          <td>{{ f.standard or '-' }}</td>
          <td>{{ f.division or '-' }}</td>
          <td>{{ f.teacher_name or '-' }}</td>
          <td>{{ f.feedback_text }}</td>
          <td>
            {% if f.sentiment_label == 'Positive' %}
              <span class="badge-success" style="font-size:0.75rem;">{{ f.sentiment_label }}</span>
            {% elif f.sentiment_label == 'Negative' %}
              <span class="badge-danger" style="font-size:0.75rem;">{{ f.sentiment_label }}</span>
            {% elif f.sentiment_label %}
              <span class="badge-warning" style="font-size:0.75rem;">{{ f.sentiment_label }}</span>
            {% else %}
              <span style="color:var(--muted);">-</span>
            {% endif %}
          </td>
          <td>{{ f.created_at[:10] if f.created_at else '-' }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  {% else %}
  <p style="color:var(--text-muted);">No feedback received yet.</p>
  {% endif %}
</div>

<script>
const opts = { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } };

new Chart(document.getElementById("riskChart"), {
  type: "pie",
  data: { labels: ["High","Medium","Low"], datasets: [{ data: [{{high_risk}},{{medium_risk}},{{total_students - high_risk - medium_risk}}], backgroundColor: ["#ef4444","#f59e0b","#22c55e"] }] },
  options: opts
});

new Chart(document.getElementById("classChart"), {
  type: "bar",
  data: { labels: {{class_labels|tojson}}, datasets: [{ label: "High Risk", data: {{class_values|tojson}}, backgroundColor: "#e72191" }] },
  options: opts
});

new Chart(document.getElementById("genderChart"), {
  type: "doughnut",
  data: { labels: ["Boys","Girls","Other"], datasets: [{ data: [{{boys_risk}},{{girls_risk}},{{other_risk}}], backgroundColor: ["#e72191","#ff951a","#8b5cf6"] }] },
  options: opts
});
</script>

{% set chatbot_greeting = "Hi! I'm EduBot, your school analytics assistant. Ask me about school-wide trends, intervention strategies, or student data!" %}
{% set chatbot_subtitle = "School Analytics Assistant" %}
{% set chatbot_role = "principal" %}
{% include 'partials/chatbot.html' %}

{% endblock %}
